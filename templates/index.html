<!DOCTYPE html>
<html lang="{{ language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
        .drag-over { @apply border-blue-500 bg-blue-50; }
        .file-row:hover { @apply bg-gray-50; }
    </style>
    <script>
        window.__CHFS_INITIAL_STATE__ = {{ {
            "authenticated": authenticated,
            "user": user.name if user else "",
            "accessible_roots": accessible_roots,
        } | tojson }};
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div x-data="fileManager()" x-cloak class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <header class="bg-white rounded-lg shadow-sm mb-6 p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">{{ brand }}</h1>
                    <p class="text-gray-600 text-sm mt-1">
                        <span x-show="isAuthenticated" x-cloak x-text="`Welcome, ${currentUser}`"></span>
                        <span x-show="!isAuthenticated" x-cloak>Please authenticate to access files</span>
                    </p>
                </div>
                <div class="flex gap-3" x-cloak>
                    <template x-if="isAuthenticated">
                        <div class="flex gap-3">
                            <button @click="showUpload = true"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                                <i class="fas fa-upload"></i>
                                <span class="hidden sm:inline">Upload</span>
                            </button>
                            <button @click="showNewFolder = true"
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                                <i class="fas fa-folder-plus"></i>
                                <span class="hidden sm:inline">New Folder</span>
                            </button>
                            <button @click="showTextShare = true"
                                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                                <i class="fas fa-share-alt"></i>
                                <span class="hidden sm:inline">Share Text</span>
                            </button>
                            <button @click="logout()"
                                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-sign-out-alt"></i>
                                <span class="hidden sm:inline">Logout</span>
                            </button>
                        </div>
                    </template>
                    <template x-if="!isAuthenticated">
                        <button @click="focusLogin()"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                            <i class="fas fa-sign-in-alt"></i>
                            <span class="hidden sm:inline">Log In</span>
                        </button>
                    </template>
                </div>
            </div>
        </header>

        <div x-show="!isAuthenticated" x-cloak>
            <!-- Login prompt -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
                <div class="flex items-center gap-3">
                    <i class="fas fa-lock text-yellow-600"></i>
                    <div>
                        <h3 class="font-semibold text-yellow-800">Authentication Required</h3>
                        <p class="text-yellow-700 text-sm mt-1">
                            Please sign in to continue or create an account below.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Login / Register forms -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <template x-if="!showRegister">
                    <form class="space-y-5" @submit.prevent="performLogin()">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1" for="login-username">Username</label>
                                <input id="login-username" x-ref="loginUsername" type="text" x-model="loginUsername" autocomplete="username"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="Enter username" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1" for="login-password">Password</label>
                                <input id="login-password" type="password" x-model="loginPassword" autocomplete="current-password"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="Enter password" required>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                            <label class="inline-flex items-center gap-2 text-sm text-gray-600">
                                <input type="checkbox" x-model="rememberCredentials" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                Remember credentials on this device
                            </label>
                            <div class="flex items-center gap-3">
                                <button type="submit"
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                    <span>Sign In</span>
                                </button>
                                <span class="text-xs text-gray-500 hidden sm:block">Default: admin / admin123</span>
                            </div>
                        </div>
                        <p x-show="loginInfo" x-text="loginInfo" class="text-sm text-green-600"></p>
                        <p x-show="loginError" x-text="loginError" class="text-sm text-red-600"></p>
                        <p class="text-sm text-gray-600">
                            Don't have an account?
                            <button type="button" @click="switchToRegister()"
                                    class="text-blue-600 hover:text-blue-700 font-medium">
                                Create one now
                            </button>
                        </p>
                    </form>
                </template>

                <template x-if="showRegister">
                    <form class="space-y-5" @submit.prevent="performRegister()">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1" for="register-username">Username</label>
                                <input id="register-username" x-ref="registerUsername" type="text" x-model="registerUsername" autocomplete="username"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="Choose a username" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1" for="register-password">Password</label>
                                <input id="register-password" type="password" x-model="registerPassword" autocomplete="new-password"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="At least 6 characters" required>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1" for="register-confirm">Confirm Password</label>
                                <input id="register-confirm" type="password" x-model="registerConfirm" autocomplete="new-password"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="Re-enter password" required>
                            </div>
                        </div>
                        <p x-show="registerError" x-text="registerError" class="text-sm text-red-600"></p>
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                            <button type="button" @click="switchToLogin()"
                                    class="text-sm text-gray-600 hover:text-gray-800">
                                Back to sign in
                            </button>
                            <button type="submit"
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                                Create Account
                            </button>
                        </div>
                    </form>
                </template>
            </div>
        </div>

        <div x-show="isAuthenticated" x-cloak>
            <!-- Share selector -->
            <div class="bg-white rounded-lg shadow-sm mb-6 p-4">
                <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                    <label class="font-medium text-gray-700">Share:</label>
                    <select x-model="currentRoot" @change="loadFiles()"
                            class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select a share...</option>
                        <template x-for="root in accessibleRoots" :key="root">
                            <option :value="root" x-text="root"></option>
                        </template>
                    </select>

                    <!-- Breadcrumb -->
                    <div x-show="currentRoot" class="flex items-center gap-2 text-sm text-gray-600" x-cloak>
                        <i class="fas fa-folder text-gray-400"></i>
                        <span x-text="currentRoot"></span>
                        <template x-for="(part, index) in pathParts" :key="index">
                            <span>
                                <i class="fas fa-chevron-right text-gray-400 mx-1"></i>
                                <a href="#" @click.prevent="navigateToPath(index)"
                                   class="hover:text-blue-600 transition-colors" x-text="part"></a>
                            </span>
                        </template>
                    </div>
                </div>
            </div>

            <!-- File listing -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden"
                 @drop.prevent="handleDrop"
                 @dragover.prevent="$el.classList.add('drag-over')"
                 @dragleave.prevent="$el.classList.remove('drag-over')">

                <!-- Loading state -->
                <div x-show="loading" class="p-8 text-center text-gray-500" x-cloak>
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading files...</p>
                </div>

                <!-- Error state -->
                <div x-show="error && !loading" class="p-8 text-center text-red-500" x-cloak>
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p x-text="error"></p>
                    <button @click="loadFiles()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Retry
                    </button>
                </div>

                <!-- File table -->
                <div x-show="!loading && !error && files.length > 0" x-cloak>
                    <!-- Toolbar -->
                    <div class="border-b border-gray-200 p-4 bg-gray-50 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-gray-600" x-text="`${files.length} items`"></span>
                            <div x-show="selectedFiles.length > 0" class="text-sm text-blue-600" x-cloak>
                                <span x-text="`${selectedFiles.length} selected`"></span>
                                <button @click="deleteSelected()"
                                        class="ml-3 text-red-600 hover:text-red-700 font-medium">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        <button @click="selectAll()" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                            Select All
                        </button>
                    </div>

                    <!-- File list -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <th class="px-4 py-3 w-8">
                                        <input type="checkbox" @change="toggleSelectAll()"
                                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    </th>
                                    <th class="px-4 py-3">Name</th>
                                    <th class="px-4 py-3 hidden md:table-cell">Size</th>
                                    <th class="px-4 py-3 hidden lg:table-cell">Modified</th>
                                    <th class="px-4 py-3 w-32">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <!-- Parent directory -->
                                <tr x-show="currentPath !== ''" class="file-row hover:bg-gray-50 transition-colors" x-cloak>
                                    <td class="px-4 py-3"></td>
                                    <td class="px-4 py-3">
                                        <a href="#" @click.prevent="navigateUp()"
                                           class="flex items-center gap-2 text-blue-600 hover:text-blue-800 transition-colors">
                                            <i class="fas fa-level-up-alt text-gray-400"></i>
                                            <span>..</span>
                                        </a>
                                    </td>
                                    <td class="px-4 py-3 hidden md:table-cell text-gray-500">-</td>
                                    <td class="px-4 py-3 hidden lg:table-cell text-gray-500">-</td>
                                    <td class="px-4 py-3"></td>
                                </tr>

                                <!-- Files and folders -->
                                <template x-for="file in files" :key="file.path">
                                    <tr class="file-row hover:bg-gray-50 transition-colors">
                                        <td class="px-4 py-3">
                                            <input type="checkbox"
                                                   :value="file.path"
                                                   x-model="selectedFiles"
                                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        </td>
                                        <td class="px-4 py-3">
                                            <div class="flex items-center gap-2">
                                                <i :class="file.is_dir ? 'fas fa-folder text-yellow-500' : 'fas fa-file text-gray-400'"></i>
                                                <a href="#"
                                                   @click.prevent="file.is_dir ? navigateToFolder(file.path) : downloadFile(file)"
                                                   class="text-blue-600 hover:text-blue-800 transition-colors font-medium"
                                                   x-text="file.name"></a>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 hidden md:table-cell text-sm text-gray-600"
                                            x-text="file.is_dir ? '-' : formatFileSize(file.size)"></td>
                                        <td class="px-4 py-3 hidden lg:table-cell text-sm text-gray-600"
                                            x-text="formatDate(file.modified)"></td>
                                        <td class="px-4 py-3">
                                            <div class="flex gap-1">
                                                <button @click="renameFile(file)"
                                                        class="p-1 text-gray-400 hover:text-blue-600 transition-colors"
                                                        title="Rename">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button @click="deleteFile(file.path)"
                                                        class="p-1 text-gray-400 hover:text-red-600 transition-colors"
                                                        title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Empty state -->
                <div x-show="!loading && !error && files.length === 0 && currentRoot" class="p-8 text-center text-gray-500" x-cloak>
                    <i class="fas fa-folder-open text-4xl mb-4 text-gray-300"></i>
                    <p class="text-lg font-medium mb-2">This folder is empty</p>
                    <p class="text-sm">Upload files or create folders to get started</p>
                </div>
            </div>
        </div>

        <!-- Upload Modal -->
        <div x-show="showUpload" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6" @click.away="showUpload = false">
                <h3 class="text-lg font-semibold mb-4">Upload Files</h3>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center"
                     @drop.prevent="handleUploadDrop"
                     @dragover.prevent="$el.classList.add('border-blue-500', 'bg-blue-50')"
                     @dragleave.prevent="$el.classList.remove('border-blue-500', 'bg-blue-50')">
                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600 mb-2">Drop files here or click to select</p>
                    <input type="file" multiple @change="handleFileSelect" class="hidden" x-ref="fileInput">
                    <button @click="$refs.fileInput.click()" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Select Files
                    </button>
                </div>
                <div x-show="uploadFiles.length > 0" class="mt-4">
                    <h4 class="font-medium mb-2">Selected Files:</h4>
                    <template x-for="file in uploadFiles" :key="file.name">
                        <div class="flex justify-between items-center py-1 text-sm">
                            <span x-text="file.name" class="truncate"></span>
                            <span x-text="formatFileSize(file.size)" class="text-gray-500 ml-2"></span>
                        </div>
                    </template>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button @click="showUpload = false" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Cancel
                    </button>
                    <button @click="uploadFiles.length > 0 && uploadSelectedFiles()" 
                            :disabled="uploadFiles.length === 0 || uploading"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors">
                        <span x-show="!uploading">Upload</span>
                        <span x-show="uploading">Uploading...</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- New Folder Modal -->
        <div x-show="showNewFolder" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6" @click.away="showNewFolder = false">
                <h3 class="text-lg font-semibold mb-4">Create New Folder</h3>
                <input type="text" x-model="newFolderName" placeholder="Folder name" 
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       @keyup.enter="createFolder()">
                <div class="flex justify-end gap-3 mt-6">
                    <button @click="showNewFolder = false" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Cancel
                    </button>
                    <button @click="createFolder()" 
                            :disabled="!newFolderName.trim()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors">
                        Create
                    </button>
                </div>
            </div>
        </div>

        <!-- Text Share Modal -->
        <div x-show="showTextShare" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full p-6" @click.away="showTextShare = false">
                <h3 class="text-lg font-semibold mb-4">Share Text</h3>
                <textarea x-model="shareText" placeholder="Enter text to share..." 
                          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent h-32 resize-none"></textarea>
                <div x-show="shareUrl" class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <p class="text-sm text-green-800 mb-2">Share URL created:</p>
                    <div class="flex items-center gap-2">
                        <input type="text" :value="shareUrl" readonly 
                               class="flex-1 bg-white border border-green-300 rounded px-2 py-1 text-sm">
                        <button @click="copyToClipboard(shareUrl)" 
                                class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition-colors">
                            Copy
                        </button>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button @click="showTextShare = false" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Cancel
                    </button>
                    <button @click="createTextShare()" 
                            :disabled="!shareText.trim()"
                            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 disabled:opacity-50 transition-colors">
                        Create Share
                    </button>
                </div>
            </div>
        </div>

        <!-- Rename Modal -->
        <div x-show="showRename" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6" @click.away="showRename = false">
                <h3 class="text-lg font-semibold mb-4">Rename</h3>
                <input type="text" x-model="renameValue" placeholder="New name" 
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       @keyup.enter="confirmRename()">
                <div class="flex justify-end gap-3 mt-6">
                    <button @click="showRename = false" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Cancel
                    </button>
                    <button @click="confirmRename()" 
                            :disabled="!renameValue.trim()"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors">
                        Rename
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function fileManager() {
            const initial = window.__CHFS_INITIAL_STATE__ || {};
            const initialRoots = Array.isArray(initial.accessible_roots) ? initial.accessible_roots : [];
            const initialUser = initial.user || '';

            return {
                // Session state
                isAuthenticated: Boolean(initial.authenticated),
                currentUser: initialUser,
                accessibleRoots: initialRoots,
                authHeader: '',
                loginUsername: initialUser,
                loginPassword: '',
                rememberCredentials: true,
                loginError: '',
                loginInfo: '',
                showRegister: false,
                registerUsername: '',
                registerPassword: '',
                registerConfirm: '',
                registerError: '',

                // File browser state
                currentRoot: initialRoots.length > 0 ? initialRoots[0] : '',
                currentPath: '',
                files: [],
                selectedFiles: [],
                loading: false,
                error: null,

                // Modals
                showUpload: false,
                showNewFolder: false,
                showTextShare: false,
                showRename: false,

                // Form data
                uploadFiles: [],
                newFolderName: '',
                shareText: '',
                shareUrl: '',
                renameValue: '',
                renameTarget: null,
                uploading: false,

                init() {
                    const savedUser = localStorage.getItem('chfsAuthUser');
                    if (!this.loginUsername && savedUser) {
                        this.loginUsername = savedUser;
                    }

                    this.tryAutoLogin().then((autoLoggedIn) => {
                        if (!autoLoggedIn && this.isAuthenticated && this.currentRoot) {
                            this.loadFiles();
                        }
                    });
                },

                // Computed
                get pathParts() {
                    return this.currentPath ? this.currentPath.split('/').filter(p => p) : [];
                },

                buildHeaders(additional = {}) {
                    const headers = { ...additional };
                    if (this.authHeader) {
                        headers['Authorization'] = this.authHeader;
                    }
                    return headers;
                },

                createAuthHeader(username, password) {
                    return 'Basic ' + btoa(`${username}:${password}`);
                },

                clearStoredCredentials() {
                    localStorage.removeItem('chfsAuthHeader');
                    localStorage.removeItem('chfsAuthUser');
                },

                resetCredentials() {
                    this.authHeader = '';
                    this.clearStoredCredentials();
                },

                focusLogin() {
                    this.$nextTick(() => {
                        if (this.$refs.loginUsername) {
                            this.$refs.loginUsername.focus();
                        }
                    });
                },

                switchToRegister() {
                    this.showRegister = true;
                    this.registerUsername = this.loginUsername || '';
                    this.registerPassword = '';
                    this.registerConfirm = '';
                    this.registerError = '';
                    this.loginError = '';
                    this.loginInfo = '';
                    this.$nextTick(() => {
                        if (this.$refs.registerUsername) {
                            this.$refs.registerUsername.focus();
                        }
                    });
                },

                switchToLogin(message = '') {
                    this.showRegister = false;
                    this.registerUsername = '';
                    this.registerPassword = '';
                    this.registerConfirm = '';
                    this.registerError = '';
                    if (message) {
                        this.loginInfo = message;
                        this.loginError = '';
                    } else {
                        this.loginInfo = '';
                    }
                    this.$nextTick(() => this.focusLogin());
                },

                async performRegister() {
                    const username = (this.registerUsername || '').trim();
                    this.registerError = '';
                    this.loginInfo = '';
                    if (!username || username.length < 3) {
                        this.registerError = 'Username must be at least 3 characters.';
                        return;
                    }

                    if (!this.registerPassword || this.registerPassword.length < 6) {
                        this.registerError = 'Password must be at least 6 characters.';
                        return;
                    }

                    if (this.registerPassword !== this.registerConfirm) {
                        this.registerError = 'Passwords do not match.';
                        return;
                    }

                    try {
                        const response = await fetch('/api/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                username,
                                password: this.registerPassword,
                                confirmPassword: this.registerConfirm,
                            }),
                        });

                        const payload = this.parseApiResponse(await response.json());
                        if (response.ok && payload.code === 0) {
                            this.registerError = '';
                            this.loginUsername = username;
                            this.loginPassword = '';
                            this.switchToLogin('Registration successful! Please sign in.');
                        } else {
                            this.registerError = payload?.msg || 'Registration failed.';
                        }
                    } catch (e) {
                        this.registerError = 'Registration failed: ' + e.message;
                    }
                },

                async tryAutoLogin() {
                    const savedHeader = localStorage.getItem('chfsAuthHeader');
                    const savedUser = localStorage.getItem('chfsAuthUser');

                    if (savedUser && !this.loginUsername) {
                        this.loginUsername = savedUser;
                    }

                    if (savedHeader) {
                        this.authHeader = savedHeader;
                        this.rememberCredentials = true;
                        const success = await this.refreshSession(false);
                        if (success) {
                            if (this.currentRoot) {
                                await this.loadFiles();
                            }
                            return true;
                        }
                        this.resetCredentials();
                    }

                    if (!this.isAuthenticated) {
                        this.focusLogin();
                    }

                    return false;
                },

                ensureAuthenticated(showMessage = true) {
                    if (this.isAuthenticated || this.authHeader) {
                        return true;
                    }
                    if (showMessage) {
                        this.loginError = 'Please log in to continue.';
                        this.loginInfo = '';
                        this.focusLogin();
                    }
                    return false;
                },

                parseApiResponse(data) {
                    if (data && typeof data === 'object' && 'detail' in data) {
                        return data.detail;
                    }
                    return data;
                },

                async refreshSession(showErrors = true) {
                    if (!this.authHeader) {
                        return false;
                    }

                    try {
                        const response = await fetch('/api/session', {
                            headers: this.buildHeaders()
                        });

                    if (response.status === 401) {
                        if (showErrors) {
                            this.loginError = 'Invalid username or password.';
                            this.loginInfo = '';
                        }
                        this.handleUnauthorized(null);
                        return false;
                    }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.isAuthenticated = true;
                            this.loginError = '';
                            this.loginInfo = '';
                            this.currentUser = payload.data?.user?.name || this.loginUsername;
                            if (!this.loginUsername) {
                                this.loginUsername = this.currentUser;
                            }

                            const roots = Array.isArray(payload.data?.roots) ? payload.data.roots : [];
                            this.accessibleRoots = roots;
                            if (!this.currentRoot || !roots.includes(this.currentRoot)) {
                                this.currentRoot = roots[0] || '';
                                this.currentPath = '';
                            }
                            return true;
                        }

                        if (showErrors) {
                            this.loginError = payload.msg || 'Failed to verify credentials.';
                            this.loginInfo = '';
                        }
                        return false;
                    } catch (e) {
                        if (showErrors) {
                            this.loginError = 'Login failed: ' + e.message;
                            this.loginInfo = '';
                        }
                        return false;
                    }
                },

                async performLogin() {
                    const username = (this.loginUsername || '').trim();
                    if (!username || !this.loginPassword) {
                        this.loginError = 'Please enter username and password.';
                        this.loginInfo = '';
                        this.focusLogin();
                        return false;
                    }

                    try {
                        this.loginUsername = username;
                        this.authHeader = this.createAuthHeader(username, this.loginPassword);
                    } catch (e) {
                        this.loginError = 'Failed to encode credentials.';
                        this.loginInfo = '';
                        return false;
                    }

                    const success = await this.refreshSession(true);
                    if (success) {
                        this.error = null;
                        this.loginPassword = '';
                        this.loginError = '';
                        this.loginInfo = '';

                        if (this.rememberCredentials) {
                            localStorage.setItem('chfsAuthHeader', this.authHeader);
                            localStorage.setItem('chfsAuthUser', this.currentUser);
                        } else {
                            this.clearStoredCredentials();
                        }

                        if (this.currentRoot) {
                            await this.loadFiles();
                        } else {
                            this.files = [];
                            this.selectedFiles = [];
                        }
                    } else {
                        this.resetCredentials();
                    }
                    return success;
                },

                handleUnauthorized(message = 'Session expired. Please log in again.') {
                    this.isAuthenticated = false;
                    this.accessibleRoots = [];
                    this.files = [];
                    this.currentRoot = '';
                    this.currentPath = '';
                    this.selectedFiles = [];
                    this.showUpload = false;
                    this.showNewFolder = false;
                    this.showTextShare = false;
                    this.showRename = false;
                    this.uploadFiles = [];
                    this.uploading = false;
                    this.shareText = '';
                    this.shareUrl = '';
                    this.renameTarget = null;
                    this.renameValue = '';

                    if (message !== null) {
                        this.error = message;
                        this.loginError = message;
                        this.loginInfo = '';
                    }

                    this.resetCredentials();
                    this.focusLogin();
                },

                logout() {
                    this.isAuthenticated = false;
                    this.accessibleRoots = [];
                    this.files = [];
                    this.currentRoot = '';
                    this.currentPath = '';
                    this.selectedFiles = [];
                    this.error = null;
                    this.loginError = '';
                    this.loginPassword = '';
                    this.showUpload = false;
                    this.showNewFolder = false;
                    this.showTextShare = false;
                    this.showRename = false;
                    this.uploadFiles = [];
                    this.uploading = false;
                    this.shareText = '';
                    this.shareUrl = '';
                    this.renameTarget = null;
                    this.renameValue = '';
                    this.resetCredentials();
                    this.focusLogin();
                },

                async loadFiles() {
                    if (!this.currentRoot) {
                        this.files = [];
                        this.selectedFiles = [];
                        return;
                    }

                    if (!this.ensureAuthenticated(false)) {
                        return;
                    }

                    this.loading = true;
                    this.error = null;

                    try {
                        const response = await fetch(`/api/list?root=${encodeURIComponent(this.currentRoot)}&path=${encodeURIComponent(this.currentPath)}`, {
                            headers: this.buildHeaders()
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.files = payload.data?.files || [];
                            this.selectedFiles = [];
                        } else {
                            this.error = payload.msg || 'Failed to load files.';
                        }
                    } catch (e) {
                        this.error = 'Failed to load files: ' + e.message;
                    } finally {
                        this.loading = false;
                    }
                },

                navigateToFolder(path) {
                    this.currentPath = path;
                    this.selectedFiles = [];
                    this.loadFiles();
                },

                navigateUp() {
                    const parts = this.pathParts;
                    parts.pop();
                    this.currentPath = parts.join('/');
                    this.selectedFiles = [];
                    this.loadFiles();
                },

                navigateToPath(index) {
                    const parts = this.pathParts.slice(0, index + 1);
                    this.currentPath = parts.join('/');
                    this.selectedFiles = [];
                    this.loadFiles();
                },

                async downloadFile(file) {
                    if (!file || !file.path) return;
                    if (!this.ensureAuthenticated(false)) return;

                    try {
                        const response = await fetch(`/api/download?root=${encodeURIComponent(this.currentRoot)}&path=${encodeURIComponent(file.path)}`, {
                            headers: this.buildHeaders()
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        if (!response.ok) {
                            throw new Error('Download failed with status ' + response.status);
                        }

                        const blob = await response.blob();
                        let filename = file.name || file.path.split('/').pop() || 'download';
                        const disposition = response.headers.get('content-disposition');
                        if (disposition) {
                            const utfMatch = disposition.match(/filename\*=UTF-8''([^;]+)/i);
                            const asciiMatch = disposition.match(/filename="?([^";]+)"?/i);
                            if (utfMatch) {
                                filename = decodeURIComponent(utfMatch[1]);
                            } else if (asciiMatch) {
                                filename = asciiMatch[1];
                            }
                        }

                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    } catch (e) {
                        alert('Download failed: ' + e.message);
                    }
                },

                async deleteFile(path) {
                    if (!this.ensureAuthenticated()) return;
                    if (!confirm('Are you sure you want to delete this item?')) return;

                    try {
                        const response = await fetch('/api/delete', {
                            method: 'POST',
                            headers: this.buildHeaders({'Content-Type': 'application/json'}),
                            body: JSON.stringify({
                                root: this.currentRoot,
                                paths: [path]
                            })
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.loadFiles();
                        } else {
                            alert('Delete failed: ' + (payload.msg || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Delete failed: ' + e.message);
                    }
                },

                async deleteSelected() {
                    if (!this.ensureAuthenticated()) return;
                    if (this.selectedFiles.length === 0) return;
                    if (!confirm(`Delete ${this.selectedFiles.length} selected items?`)) return;

                    try {
                        const response = await fetch('/api/delete', {
                            method: 'POST',
                            headers: this.buildHeaders({'Content-Type': 'application/json'}),
                            body: JSON.stringify({
                                root: this.currentRoot,
                                paths: this.selectedFiles
                            })
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.selectedFiles = [];
                            this.loadFiles();
                        } else {
                            alert('Delete failed: ' + (payload.msg || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Delete failed: ' + e.message);
                    }
                },

                renameFile(file) {
                    this.renameTarget = file;
                    this.renameValue = file?.name || '';
                    this.showRename = true;
                },

                async confirmRename() {
                    if (!this.ensureAuthenticated()) return;
                    if (!this.renameTarget || !this.renameValue.trim()) return;

                    try {
                        const response = await fetch('/api/rename', {
                            method: 'POST',
                            headers: this.buildHeaders({'Content-Type': 'application/json'}),
                            body: JSON.stringify({
                                root: this.currentRoot,
                                path: this.renameTarget.path,
                                newName: this.renameValue.trim()
                            })
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.showRename = false;
                            this.renameTarget = null;
                            this.renameValue = '';
                            this.loadFiles();
                        } else {
                            alert('Rename failed: ' + (payload.msg || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Rename failed: ' + e.message);
                    }
                },

                async createFolder() {
                    if (!this.ensureAuthenticated()) return;
                    if (!this.newFolderName.trim()) return;

                    try {
                        const response = await fetch('/api/mkdir', {
                            method: 'POST',
                            headers: this.buildHeaders({'Content-Type': 'application/json'}),
                            body: JSON.stringify({
                                root: this.currentRoot,
                                path: this.currentPath ? `${this.currentPath}/${this.newFolderName}` : this.newFolderName
                            })
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.showNewFolder = false;
                            this.newFolderName = '';
                            this.loadFiles();
                        } else {
                            alert('Create folder failed: ' + (payload.msg || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Create folder failed: ' + e.message);
                    }
                },

                handleFileSelect(event) {
                    this.uploadFiles = Array.from(event.target.files);
                },

                handleUploadDrop(event) {
                    event.target.classList.remove('border-blue-500', 'bg-blue-50');
                    this.uploadFiles = Array.from(event.dataTransfer.files);
                },

                handleDrop(event) {
                    event.target.classList.remove('drag-over');
                    this.uploadFiles = Array.from(event.dataTransfer.files);
                    this.showUpload = true;
                },

                async uploadSelectedFiles() {
                    if (!this.ensureAuthenticated()) return;
                    if (this.uploadFiles.length === 0) return;

                    this.uploading = true;

                    try {
                        for (const file of this.uploadFiles) {
                            const formData = new FormData();
                            formData.append('root', this.currentRoot);
                            formData.append('path', this.currentPath);
                            formData.append('file', file);

                            const response = await fetch('/api/upload', {
                                method: 'POST',
                                headers: this.buildHeaders(),
                                body: formData
                            });

                            if (response.status === 401) {
                                this.handleUnauthorized();
                                return;
                            }

                            const payload = this.parseApiResponse(await response.json());
                            if (payload.code !== 0) {
                                alert(`Upload failed for ${file.name}: ${payload.msg || 'Unknown error'}`);
                            }
                        }

                        this.showUpload = false;
                        this.uploadFiles = [];
                        this.loadFiles();

                    } catch (e) {
                        alert('Upload failed: ' + e.message);
                    } finally {
                        this.uploading = false;
                    }
                },

                async createTextShare() {
                    if (!this.ensureAuthenticated()) return;
                    if (!this.shareText.trim()) return;

                    try {
                        const response = await fetch('/api/textshare', {
                            method: 'POST',
                            headers: this.buildHeaders({'Content-Type': 'application/json'}),
                            body: JSON.stringify({ text: this.shareText })
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.shareUrl = window.location.origin + payload.data.url;
                        } else {
                            alert('Text share failed: ' + (payload.msg || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Text share failed: ' + e.message);
                    }
                },

                selectAll() {
                    this.selectedFiles = this.files.map(f => f.path);
                },

                toggleSelectAll() {
                    if (this.selectedFiles.length === this.files.length) {
                        this.selectedFiles = [];
                    } else {
                        this.selectAll();
                    }
                },

                copyToClipboard(text) {
                    navigator.clipboard.writeText(text).then(() => {
                        alert('Copied to clipboard!');
                    });
                },

                formatFileSize(bytes) {
                    if (!bytes) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                },

                formatDate(timestamp) {
                    if (!timestamp) return '';
                    const date = new Date(timestamp * 1000);
                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                }
            };
        }
    </script>
</body>
</html>
