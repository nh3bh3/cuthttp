<!DOCTYPE html>
<html lang="{{ language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
        .drag-over { @apply border-blue-500 bg-blue-50; }
        .file-row:hover { @apply bg-gray-50; }
    </style>
    <script>
        window.__CHFS_INITIAL_STATE__ = {{ {
            "authenticated": authenticated,
            "user": user.name if user else "",
            "accessible_roots": accessible_roots,
        } | tojson }};
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div x-data="fileManager()" x-cloak class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <header class="bg-white rounded-lg shadow-sm mb-6 p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">{{ brand }}</h1>
                    <p class="text-gray-600 text-sm mt-1">
                        <span x-show="isAuthenticated" x-cloak x-text="`Welcome, ${currentUser}`"></span>
                        <span x-show="!isAuthenticated" x-cloak>Please authenticate to access files</span>
                    </p>
                </div>
                <div class="flex gap-3" x-cloak>
                    <template x-if="isAuthenticated">
                        <div class="flex gap-3">
                            <button @click="showUpload = true"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                                <i class="fas fa-upload"></i>
                                <span class="hidden sm:inline">Upload</span>
                            </button>
                            <button @click="showNewFolder = true"
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                                <i class="fas fa-folder-plus"></i>
                                <span class="hidden sm:inline">New Folder</span>
                            </button>
                            <button @click="openDirectTransfer()"
                                    class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                                <i class="fas fa-paper-plane"></i>
                                <span class="hidden sm:inline">Direct Transfer</span>
                            </button>
                            <button @click="openControlPanel()"
                                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                                <i class="fas fa-sliders-h"></i>
                                <span class="hidden sm:inline">Control Panel</span>
                            </button>
                            <button @click="logout()"
                                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-sign-out-alt"></i>
                                <span class="hidden sm:inline">Logout</span>
                            </button>
                        </div>
                    </template>
                    <template x-if="!isAuthenticated">
                        <button @click="focusLogin()"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                            <i class="fas fa-sign-in-alt"></i>
                            <span class="hidden sm:inline">Log In</span>
                        </button>
                    </template>
                </div>
            </div>
        </header>

        <div x-show="!isAuthenticated" x-cloak>
            <!-- Login prompt -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
                <div class="flex items-center gap-3">
                    <i class="fas fa-lock text-yellow-600"></i>
                    <div>
                        <h3 class="font-semibold text-yellow-800">Authentication Required</h3>
                        <p class="text-yellow-700 text-sm mt-1">
                            Please sign in to continue or create an account below.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Login / Register forms -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <template x-if="!showRegister">
                    <form class="space-y-5" @submit.prevent="performLogin()">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1" for="login-username">Username</label>
                                <input id="login-username" x-ref="loginUsername" type="text" x-model="loginUsername" autocomplete="username"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="Enter username" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1" for="login-password">Password</label>
                                <input id="login-password" type="password" x-model="loginPassword" autocomplete="current-password"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="Enter password" required>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                            <label class="inline-flex items-center gap-2 text-sm text-gray-600">
                                <input type="checkbox" x-model="rememberCredentials" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                Remember credentials on this device
                            </label>
                            <div class="flex items-center gap-3">
                                <button type="submit"
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                    <span>Sign In</span>
                                </button>
                                <span class="text-xs text-gray-500 hidden sm:block">Default: admin / admin123</span>
                            </div>
                        </div>
                        <p x-show="loginInfo" x-text="loginInfo" class="text-sm text-green-600"></p>
                        <p x-show="loginError" x-text="loginError" class="text-sm text-red-600"></p>
                        <p class="text-sm text-gray-600">
                            Don't have an account?
                            <button type="button" @click="switchToRegister()"
                                    class="text-blue-600 hover:text-blue-700 font-medium">
                                Create one now
                            </button>
                        </p>
                    </form>
                </template>

                <template x-if="showRegister">
                    <form class="space-y-5" @submit.prevent="performRegister()">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1" for="register-username">Username</label>
                                <input id="register-username" x-ref="registerUsername" type="text" x-model="registerUsername" autocomplete="username"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="Choose a username" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1" for="register-password">Password</label>
                                <input id="register-password" type="password" x-model="registerPassword" autocomplete="new-password"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="At least 6 characters" required>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1" for="register-confirm">Confirm Password</label>
                                <input id="register-confirm" type="password" x-model="registerConfirm" autocomplete="new-password"
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="Re-enter password" required>
                            </div>
                        </div>
                        <p x-show="registerError" x-text="registerError" class="text-sm text-red-600"></p>
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                            <button type="button" @click="switchToLogin()"
                                    class="text-sm text-gray-600 hover:text-gray-800">
                                Back to sign in
                            </button>
                            <button type="submit"
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                                Create Account
                            </button>
                        </div>
                    </form>
                </template>
            </div>
        </div>

        <div x-show="isAuthenticated" x-cloak>
            <!-- Share selector -->
            <div class="bg-white rounded-lg shadow-sm mb-6 p-4">
                <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                    <label class="font-medium text-gray-700">Share:</label>
                    <select x-model="currentRoot" @change="loadFiles()"
                            class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select a share...</option>
                        <template x-for="root in accessibleRoots" :key="root">
                            <option :value="root" x-text="root"></option>
                        </template>
                    </select>

                    <!-- Breadcrumb -->
                    <div x-show="currentRoot" class="flex items-center gap-2 text-sm text-gray-600" x-cloak>
                        <i class="fas fa-folder text-gray-400"></i>
                        <span x-text="currentRoot"></span>
                        <template x-for="(part, index) in pathParts" :key="index">
                            <span>
                                <i class="fas fa-chevron-right text-gray-400 mx-1"></i>
                                <a href="#" @click.prevent="navigateToPath(index)"
                                   class="hover:text-blue-600 transition-colors" x-text="part"></a>
                            </span>
                        </template>
                    </div>
                </div>
            </div>

            <!-- File listing -->
            <div class="bg-white rounded-lg shadow-sm overflow-hidden"
                 @drop.prevent="handleDrop"
                 @dragover.prevent="$el.classList.add('drag-over')"
                 @dragleave.prevent="$el.classList.remove('drag-over')">

                <!-- Loading state -->
                <div x-show="loading" class="p-8 text-center text-gray-500" x-cloak>
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading files...</p>
                </div>

                <!-- Error state -->
                <div x-show="error && !loading" class="p-8 text-center text-red-500" x-cloak>
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <p x-text="error"></p>
                    <button @click="loadFiles()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Retry
                    </button>
                </div>

                <!-- File table -->
                <div x-show="!loading && !error && files.length > 0" x-cloak>
                    <!-- Toolbar -->
                    <div class="border-b border-gray-200 p-4 bg-gray-50 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-gray-600" x-text="`${files.length} items`"></span>
                            <div x-show="selectedFiles.length > 0" class="text-sm text-blue-600" x-cloak>
                                <span x-text="`${selectedFiles.length} selected`"></span>
                                <button @click="deleteSelected()"
                                        class="ml-3 text-red-600 hover:text-red-700 font-medium">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        <button @click="selectAll()" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                            Select All
                        </button>
                    </div>

                    <!-- File list -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <th class="px-4 py-3 w-8">
                                        <input type="checkbox" @change="toggleSelectAll()"
                                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    </th>
                                    <th class="px-4 py-3">Name</th>
                                    <th class="px-4 py-3 hidden md:table-cell">Size</th>
                                    <th class="px-4 py-3 hidden lg:table-cell">Modified</th>
                                    <th class="px-4 py-3 w-32">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <!-- Parent directory -->
                                <tr x-show="currentPath !== ''" class="file-row hover:bg-gray-50 transition-colors" x-cloak>
                                    <td class="px-4 py-3"></td>
                                    <td class="px-4 py-3">
                                        <a href="#" @click.prevent="navigateUp()"
                                           class="flex items-center gap-2 text-blue-600 hover:text-blue-800 transition-colors">
                                            <i class="fas fa-level-up-alt text-gray-400"></i>
                                            <span>..</span>
                                        </a>
                                    </td>
                                    <td class="px-4 py-3 hidden md:table-cell text-gray-500">-</td>
                                    <td class="px-4 py-3 hidden lg:table-cell text-gray-500">-</td>
                                    <td class="px-4 py-3"></td>
                                </tr>

                                <!-- Files and folders -->
                                <template x-for="file in files" :key="file.path">
                                    <tr class="file-row hover:bg-gray-50 transition-colors">
                                        <td class="px-4 py-3">
                                            <input type="checkbox"
                                                   :value="file.path"
                                                   x-model="selectedFiles"
                                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        </td>
                                        <td class="px-4 py-3">
                                            <div class="flex items-center gap-2">
                                                <i :class="file.is_dir ? 'fas fa-folder text-yellow-500' : 'fas fa-file text-gray-400'"></i>
                                                <a href="#"
                                                   @click.prevent="file.is_dir ? navigateToFolder(file.path) : downloadFile(file)"
                                                   class="text-blue-600 hover:text-blue-800 transition-colors font-medium"
                                                   x-text="file.name"></a>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 hidden md:table-cell text-sm text-gray-600"
                                            x-text="file.is_dir ? '-' : formatFileSize(file.size)"></td>
                                        <td class="px-4 py-3 hidden lg:table-cell text-sm text-gray-600"
                                            x-text="formatDate(file.modified)"></td>
                                        <td class="px-4 py-3">
                                            <div class="flex gap-1">
                                                <button @click="renameFile(file)"
                                                        class="p-1 text-gray-400 hover:text-blue-600 transition-colors"
                                                        title="Rename">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button @click="deleteFile(file.path)"
                                                        class="p-1 text-gray-400 hover:text-red-600 transition-colors"
                                                        title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Empty state -->
                <div x-show="!loading && !error && files.length === 0 && currentRoot" class="p-8 text-center text-gray-500" x-cloak>
                    <i class="fas fa-folder-open text-4xl mb-4 text-gray-300"></i>
                    <p class="text-lg font-medium mb-2">This folder is empty</p>
                    <p class="text-sm">Upload files or create folders to get started</p>
                </div>
            </div>
        </div>

        <!-- Upload Modal -->
        <div x-show="showUpload" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6" @click.away="showUpload = false">
                <h3 class="text-lg font-semibold mb-4">Upload Files</h3>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center"
                     @drop.prevent="handleUploadDrop"
                     @dragover.prevent="$el.classList.add('border-blue-500', 'bg-blue-50')"
                     @dragleave.prevent="$el.classList.remove('border-blue-500', 'bg-blue-50')">
                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600 mb-2">Drop files here or click to select</p>
                    <input type="file" multiple @change="handleFileSelect" class="hidden" x-ref="fileInput">
                    <button @click="$refs.fileInput.click()" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Select Files
                    </button>
                </div>
                <div x-show="uploadFiles.length > 0" class="mt-4">
                    <h4 class="font-medium mb-2">Selected Files:</h4>
                    <template x-for="file in uploadFiles" :key="file.name">
                        <div class="flex justify-between items-center py-1 text-sm">
                            <span x-text="file.name" class="truncate"></span>
                            <span x-text="formatFileSize(file.size)" class="text-gray-500 ml-2"></span>
                        </div>
                    </template>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button @click="showUpload = false" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Cancel
                    </button>
                    <button @click="uploadFiles.length > 0 && uploadSelectedFiles()" 
                            :disabled="uploadFiles.length === 0 || uploading"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors">
                        <span x-show="!uploading">Upload</span>
                        <span x-show="uploading">Uploading...</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- New Folder Modal -->
        <div x-show="showNewFolder" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6" @click.away="showNewFolder = false">
                <h3 class="text-lg font-semibold mb-4">Create New Folder</h3>
                <input type="text" x-model="newFolderName" placeholder="Folder name" 
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       @keyup.enter="createFolder()">
                <div class="flex justify-end gap-3 mt-6">
                    <button @click="showNewFolder = false" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Cancel
                    </button>
                    <button @click="createFolder()" 
                            :disabled="!newFolderName.trim()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors">
                        Create
                    </button>
                </div>
            </div>
        </div>

        <!-- Direct Transfer Modal -->
        <div x-show="showDirectTransfer" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-3xl w-full p-6 space-y-4" @click.away="closeDirectTransfer()">
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Direct Transfer</h3>
                        <p class="text-sm text-gray-500">Send files directly to another user on this server.</p>
                    </div>
                    <button @click="closeDirectTransfer()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div x-show="directTransferSuccess" class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg" x-text="directTransferSuccess"></div>
                <div x-show="directTransferError" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg" x-text="directTransferError"></div>
                <div x-show="directTransferListError" class="bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded-lg" x-text="directTransferListError"></div>

                <form class="space-y-4" @submit.prevent="sendDirectTransfer()">
                    <div class="grid gap-4 md:grid-cols-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Recipient</label>
                            <select x-model="directTransferRecipient"
                                    :disabled="directTransferRecipientsLoading || directTransferRecipients.length === 0"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                <option value="" disabled>Select recipient</option>
                                <template x-for="recipient in directTransferRecipients" :key="`recipient-${recipient}`">
                                    <option :value="recipient" x-text="recipient"></option>
                                </template>
                            </select>
                            <p x-show="directTransferRecipientsLoading" class="text-xs text-gray-500 mt-1">Loading users…</p>
                            <p x-show="!directTransferRecipientsLoading && directTransferRecipients.length === 0" class="text-xs text-gray-500 mt-1">No other users are currently available.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">File</label>
                            <input type="file" @change="handleDirectTransferFile($event)" x-ref="directTransferFileInput"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            <p x-show="directTransferFile" class="text-xs text-gray-600 mt-2 flex items-center gap-2">
                                <span class="font-medium" x-text="directTransferFile?.name"></span>
                                <span x-text="formatFileSize(directTransferFile?.size || 0)" class="text-gray-500"></span>
                            </p>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" @click="closeDirectTransfer()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">Cancel</button>
                        <button type="submit"
                                :disabled="directTransferSending || !directTransferRecipient || !directTransferFile"
                                class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg disabled:opacity-50 transition-colors">
                            <span x-show="!directTransferSending">Send</span>
                            <span x-show="directTransferSending">Sending…</span>
                        </button>
                    </div>
                </form>

                <div class="border-t border-gray-200 pt-4">
                    <div class="flex flex-wrap items-center gap-3 mb-4">
                        <div class="flex gap-2">
                            <button type="button"
                                    @click="directTransferTab = 'incoming'"
                                    :class="directTransferTab === 'incoming' ? 'bg-orange-600 text-white' : 'bg-gray-200 text-gray-700'"
                                    class="px-3 py-1 rounded-lg text-sm font-medium transition-colors">
                                Incoming
                            </button>
                            <button type="button"
                                    @click="directTransferTab = 'outgoing'"
                                    :class="directTransferTab === 'outgoing' ? 'bg-orange-600 text-white' : 'bg-gray-200 text-gray-700'"
                                    class="px-3 py-1 rounded-lg text-sm font-medium transition-colors">
                                Sent
                            </button>
                        </div>
                        <button type="button" @click="refreshDirectTransferLists()"
                                class="ml-auto bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-sm transition-colors">
                            Refresh
                        </button>
                    </div>

                    <div x-show="directTransferListLoading" class="bg-blue-50 border border-blue-100 text-blue-700 px-4 py-3 rounded-lg">
                        <i class="fas fa-circle-notch fa-spin mr-2"></i>
                        Loading transfers…
                    </div>

                    <div x-show="!directTransferListLoading && directTransferTab === 'incoming'" class="space-y-3">
                        <template x-if="directTransferIncoming.length > 0">
                            <ul class="space-y-3">
                                <template x-for="item in directTransferIncoming" :key="`incoming-${item.id}`">
                                    <li class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                            <div>
                                                <p class="font-medium text-gray-800" x-text="item.filename"></p>
                                                <p class="text-sm text-gray-600">
                                                    From <span class="font-semibold" x-text="item.sender"></span>
                                                    • <span x-text="formatFileSize(item.size)"></span>
                                                    • <span x-text="formatDate(item.createdAt)"></span>
                                                    <span x-show="item.expiresAt" class="ml-2 text-orange-600">
                                                        Expires <span x-text="formatDate(item.expiresAt)"></span>
                                                    </span>
                                                </p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button @click="downloadDirectTransfer(item)"
                                                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                                    Download
                                                </button>
                                                <button @click="deleteDirectTransfer(item, 'incoming')"
                                                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm transition-colors">
                                                    Decline
                                                </button>
                                            </div>
                                        </div>
                                    </li>
                                </template>
                            </ul>
                        </template>
                        <p x-show="directTransferIncoming.length === 0" class="text-sm text-gray-500">No incoming transfers.</p>
                    </div>

                    <div x-show="!directTransferListLoading && directTransferTab === 'outgoing'" class="space-y-3">
                        <template x-if="directTransferOutgoing.length > 0">
                            <ul class="space-y-3">
                                <template x-for="item in directTransferOutgoing" :key="`outgoing-${item.id}`">
                                    <li class="border border-gray-200 rounded-lg p-4">
                                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                            <div>
                                                <p class="font-medium text-gray-800" x-text="item.filename"></p>
                                                <p class="text-sm text-gray-600">
                                                    To <span class="font-semibold" x-text="item.recipient"></span>
                                                    • <span x-text="formatFileSize(item.size)"></span>
                                                    • <span x-text="formatDate(item.createdAt)"></span>
                                                    <span x-show="item.expiresAt" class="ml-2 text-orange-600">
                                                        Expires <span x-text="formatDate(item.expiresAt)"></span>
                                                    </span>
                                                </p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button @click="deleteDirectTransfer(item, 'outgoing')"
                                                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm transition-colors">
                                                    Cancel
                                                </button>
                                            </div>
                                        </div>
                                    </li>
                                </template>
                            </ul>
                        </template>
                        <p x-show="directTransferOutgoing.length === 0" class="text-sm text-gray-500">No pending sent transfers.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rename Modal -->
        <div x-show="showRename" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6" @click.away="showRename = false">
                <h3 class="text-lg font-semibold mb-4">Rename</h3>
                <input type="text" x-model="renameValue" placeholder="New name"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       @keyup.enter="confirmRename()">
                <div class="flex justify-end gap-3 mt-6">
                    <button @click="showRename = false" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Cancel
                    </button>
                    <button @click="confirmRename()"
                            :disabled="!renameValue.trim()"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors">
                        Rename
                    </button>
                </div>
            </div>
        </div>

        <!-- Control Panel Modal -->
        <div x-show="showControlPanel" @keydown.escape.window="closeControlPanel()"
             class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
            <div class="bg-white rounded-lg shadow-2xl max-w-5xl w-full p-6 overflow-hidden" @click.away="closeControlPanel()">
                <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-4">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900">Server Control Panel</h3>
                        <p class="text-sm text-gray-500 mt-1">
                            <span x-show="controlPanelTimestamp" x-text="'Last updated: ' + controlPanelTimestamp"></span>
                            <span x-show="!controlPanelTimestamp">Load the latest status to view live metrics.</span>
                        </p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button @click="refreshControlPanel()"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                            <i class="fas fa-rotate"></i>
                            <span>Refresh</span>
                        </button>
                        <button @click="closeControlPanel()"
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-colors">
                            Close
                        </button>
                    </div>
                </div>

                <div x-show="controlPanelLoading"
                     class="flex items-center gap-2 bg-blue-50 border border-blue-100 text-blue-700 px-4 py-3 rounded-lg mb-4">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    <span>Loading latest server information…</span>
                </div>

                <div x-show="controlPanelError"
                     class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4"
                     x-text="controlPanelError"></div>

                <div x-show="controlPanelNotice"
                     class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-4"
                     x-text="controlPanelNotice"></div>

                <div x-show="!controlPanelLoading && controlPanelData" class="space-y-6 max-h-[70vh] overflow-y-auto pr-1">
                    <section class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-800">Quick LAN Access</h4>
                                <p class="text-sm text-gray-600">Share these URLs with other devices on your network.</p>
                            </div>
                            <span class="text-xs font-semibold px-3 py-1 rounded-full"
                                  :class="(controlPanelData?.ip_filter?.lan_allowed ?? false) ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                                <span x-text="(controlPanelData?.ip_filter?.lan_allowed ?? false) ? 'LAN Reachable' : 'LAN Restricted'"></span>
                            </span>
                        </div>
                        <ul class="space-y-2">
                            <template x-for="url in (controlPanelData?.server?.lan_urls || [])" :key="url">
                                <li class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 bg-white border border-gray-200 rounded-lg px-3 py-2">
                                    <span class="text-sm font-mono text-gray-800 truncate" x-text="url"></span>
                                    <a :href="url" target="_blank" rel="noopener"
                                       class="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center gap-1">
                                        <i class="fas fa-arrow-up-right-from-square"></i>
                                        Open
                                    </a>
                                </li>
                            </template>
                            <li x-show="(controlPanelData?.server?.lan_urls || []).length === 0"
                                class="text-sm text-gray-500">
                                No LAN addresses detected. The server currently binds to
                                <span class="font-mono" x-text="controlPanelData?.server?.host"></span>.
                            </li>
                        </ul>
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                                <div>
                                    <h5 class="text-base font-semibold text-gray-800">Custom URLs</h5>
                                    <p class="text-sm text-gray-600">Provide external URLs to share with people outside your LAN.</p>
                                </div>
                                <span class="text-xs text-gray-500" x-text="`${(controlPanelData?.server?.custom_urls || []).length} configured`"></span>
                            </div>
                            <ul class="mt-3 space-y-2" x-show="(controlPanelData?.server?.custom_urls || []).length">
                                <template x-for="url in (controlPanelData?.server?.custom_urls || [])" :key="`custom-${url}`">
                                    <li class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 bg-white border border-gray-200 rounded-lg px-3 py-2">
                                        <span class="text-sm font-mono text-gray-800 truncate" x-text="url"></span>
                                        <a :href="url" target="_blank" rel="noopener"
                                           class="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center gap-1">
                                            <i class="fas fa-arrow-up-right-from-square"></i>
                                            Open
                                        </a>
                                    </li>
                                </template>
                            </ul>
                            <p x-show="!(controlPanelData?.server?.custom_urls || []).length" class="text-sm text-gray-500 mt-2">
                                No custom URLs configured yet.
                            </p>
                            <label class="block text-sm font-medium text-gray-700 mt-4 mb-1" for="custom-url-editor">Modify custom URLs</label>
                            <textarea id="custom-url-editor" x-model="customUrlEditor" rows="3"
                                      placeholder="https://example.com\nhttps://share.example.net:8443"
                                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"></textarea>
                            <div class="flex items-center gap-3 mt-2">
                                <button @click="updateServerUrls()"
                                        :disabled="customUrlSaving"
                                        class="bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-4 py-2 rounded-lg transition-colors">
                                    <span x-show="!customUrlSaving">Save URLs</span>
                                    <span x-show="customUrlSaving" class="flex items-center gap-2">
                                        <i class="fas fa-circle-notch fa-spin"></i>
                                        Saving…
                                    </span>
                                </button>
                                <span class="text-xs text-gray-500">One URL per line. Only http/https links are accepted.</span>
                            </div>
                        </div>
                    </section>

                    <section class="grid md:grid-cols-2 gap-4">
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">IP Filter Configuration</h4>
                            <p class="text-sm text-gray-600 mb-3">
                                Mode:
                                <span class="font-medium text-gray-800" x-text="controlPanelData?.ip_filter?.mode || 'unknown'"></span>
                            </p>
                            <div class="space-y-2 text-sm text-gray-700">
                                <div class="font-medium text-gray-700">Allow rules (<span x-text="controlPanelData?.ip_filter?.allow_count ?? 0"></span>)</div>
                                <ul class="list-disc list-inside" x-show="(controlPanelData?.ip_filter?.allow || []).length">
                                    <template x-for="rule in controlPanelData?.ip_filter?.allow" :key="`allow-${rule}`">
                                        <li x-text="rule"></li>
                                    </template>
                                </ul>
                                <p x-show="!(controlPanelData?.ip_filter?.allow || []).length" class="text-gray-500">
                                    No explicit allow rules; all addresses are permitted unless denied.
                                </p>
                            </div>
                            <div class="mt-4 space-y-2 text-sm text-gray-700">
                                <div class="font-medium text-gray-700">Deny rules (<span x-text="controlPanelData?.ip_filter?.deny_count ?? 0"></span>)</div>
                                <ul class="list-disc list-inside" x-show="(controlPanelData?.ip_filter?.deny || []).length">
                                    <template x-for="rule in controlPanelData?.ip_filter?.deny" :key="`deny-${rule}`">
                                        <li x-text="rule"></li>
                                    </template>
                                </ul>
                                <p x-show="!(controlPanelData?.ip_filter?.deny || []).length" class="text-gray-500">
                                    No deny rules are configured.
                                </p>
                            </div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-4 space-y-2">
                            <h4 class="font-semibold text-gray-800">LAN Reachability Details</h4>
                            <p class="text-sm text-gray-600" x-show="controlPanelData?.ip_filter?.lan_allowed">
                                Private network traffic is currently allowed. These rules grant access:
                            </p>
                            <ul class="list-disc list-inside text-sm text-gray-700"
                                x-show="(controlPanelData?.ip_filter?.lan_allowing_rules || []).length">
                                <template x-for="rule in controlPanelData?.ip_filter?.lan_allowing_rules" :key="`lan-allow-${rule}`">
                                    <li x-text="rule"></li>
                                </template>
                            </ul>
                            <p class="text-sm text-red-600" x-show="!(controlPanelData?.ip_filter?.lan_allowed)">
                                Private networks are blocked by the current rules. Add your LAN ranges to the allow list or remove blocking entries.
                            </p>
                            <ul class="list-disc list-inside text-sm text-red-600"
                                x-show="(controlPanelData?.ip_filter?.lan_blocking_rules || []).length">
                                <template x-for="rule in controlPanelData?.ip_filter?.lan_blocking_rules" :key="`lan-block-${rule}`">
                                    <li x-text="rule"></li>
                                </template>
                            </ul>
                        </div>
                    </section>

                    <section class="bg-white border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-semibold text-gray-800">Shares</h4>
                            <span class="text-xs text-gray-500" x-text="`Configured: ${(controlPanelData?.shares || []).length}`"></span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-medium text-gray-600">Name</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-600">Path</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-600">Status</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-600">Disk</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-600">Storage</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <template x-for="share in (controlPanelData?.shares || [])" :key="share.name">
                                        <tr>
                                            <td class="px-3 py-2 font-medium text-gray-800" x-text="share.name"></td>
                                            <td class="px-3 py-2 font-mono text-xs text-gray-600 truncate" x-text="share.path"></td>
                                            <td class="px-3 py-2">
                                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold"
                                                      :class="share.exists ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                                                    <i :class="share.exists ? 'fas fa-check' : 'fas fa-triangle-exclamation'"></i>
                                                    <span x-text="share.exists ? 'Available' : 'Missing'"></span>
                                                </span>
                                                <div class="text-xs text-gray-500 mt-1 flex items-center gap-2">
                                                    <span :class="share.readable ? 'text-green-600' : 'text-red-600'">
                                                        <i class="fas fa-eye"></i>
                                                        <span x-text="share.readable ? 'readable' : 'no read access'"></span>
                                                    </span>
                                                    <span class="text-gray-400">•</span>
                                                    <span :class="share.writable ? 'text-green-600' : 'text-red-600'">
                                                        <i class="fas fa-pen"></i>
                                                        <span x-text="share.writable ? 'writable' : 'read-only'"></span>
                                                    </span>
                                                </div>
                                            </td>
                                            <td class="px-3 py-2 text-xs text-gray-600">
                                                <template x-if="share.disk">
                                                    <div class="space-y-1">
                                                        <div>
                                                            <span class="font-medium text-gray-700">Total:</span>
                                                            <span x-text="formatFileSize(share.disk.total)"></span>
                                                        </div>
                                                        <div>
                                                            <span class="font-medium text-gray-700">Free:</span>
                                                            <span x-text="formatFileSize(share.disk.free)"></span>
                                                        </div>
                                                    </div>
                                                </template>
                                                <p x-show="!share.disk" class="text-gray-400">Disk usage unavailable</p>
                                            </td>
                                            <td class="px-3 py-2 text-xs text-gray-700 space-y-2">
                                                <div>
                                                    <span class="font-medium text-gray-700">Used:</span>
                                                    <span x-text="share.usage?.display || '0 B'"></span>
                                                </div>
                                                <template x-if="share.quota_enabled">
                                                    <div class="space-y-1">
                                                        <div>
                                                            <span class="font-medium text-gray-700">Limit:</span>
                                                            <span x-text="share.quota?.limit_display || '—'"></span>
                                                        </div>
                                                        <div>
                                                            <span class="font-medium text-gray-700">Remaining:</span>
                                                            <span x-text="share.quota?.remaining_display || '0 B'"></span>
                                                        </div>
                                                        <div>
                                                            <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                                                                <div class="h-2" :class="share.quota?.over ? 'bg-red-500' : 'bg-blue-600'"
                                                                     :style="`width: ${Math.min(share.quota?.percent_used ?? 0, 100)}%`"></div>
                                                            </div>
                                                            <div class="text-[10px] text-gray-500 mt-1">
                                                                <span x-text="(share.quota?.percent_used ?? 0).toFixed(1)"></span>% used
                                                            </div>
                                                        </div>
                                                    </div>
                                                </template>
                                                <p x-show="!share.quota_enabled" class="text-gray-400">No quota limit</p>
                                                <div class="flex flex-wrap gap-2 pt-1">
                                                    <button @click="promptShareQuota(share)"
                                                            class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors">
                                                        Set quota
                                                    </button>
                                                    <button x-show="share.quota_enabled"
                                                            @click="clearShareQuota(share)"
                                                            class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors">
                                                        Remove limit
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                    <tr x-show="(controlPanelData?.shares || []).length === 0">
                                        <td colspan="5" class="px-3 py-4 text-center text-gray-500">No shares configured.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <section class="bg-white border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-semibold text-gray-800">User Accounts</h4>
                            <span class="text-xs text-gray-500"
                                  x-text="`Total: ${(controlPanelData?.users || []).length}`"></span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">
                            Users registered via the control panel can be removed from here. Accounts defined in
                            the configuration file are read-only.
                        </p>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead>
                                    <tr class="text-left text-gray-600 border-b border-gray-200">
                                        <th class="px-3 py-2">Username</th>
                                        <th class="px-3 py-2">Source</th>
                                        <th class="px-3 py-2">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <template x-for="user in (controlPanelData?.users || [])" :key="user.name">
                                        <tr>
                                            <td class="px-3 py-2 font-medium text-gray-800" x-text="user.name"></td>
                                            <td class="px-3 py-2">
                                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs"
                                                      :class="user.dynamic ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'">
                                                    <i :class="user.dynamic ? 'fas fa-user-plus' : 'fas fa-file-lines'"></i>
                                                    <span x-text="user.dynamic ? 'Dynamic' : 'Config file'"></span>
                                                </span>
                                            </td>
                                            <td class="px-3 py-2">
                                                <button x-show="user.dynamic"
                                                        @click="removeUser(user.name)"
                                                        class="text-xs px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors">
                                                    Remove
                                                </button>
                                                <span x-show="!user.dynamic" class="text-xs text-gray-400">Managed externally</span>
                                            </td>
                                        </tr>
                                    </template>
                                    <tr x-show="!(controlPanelData?.users || []).length">
                                        <td colspan="3" class="px-3 py-4 text-center text-gray-500">No users available.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <section class="grid md:grid-cols-2 gap-4">
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Traffic &amp; Performance</h4>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-gray-500">Total Requests</div>
                                    <div class="text-xl font-semibold text-gray-900" x-text="controlPanelData?.metrics?.requests?.total ?? 0"></div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-gray-500">Active Requests</div>
                                    <div class="text-xl font-semibold text-gray-900" x-text="controlPanelData?.metrics?.requests?.active ?? 0"></div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-gray-500">Avg Response (s)</div>
                                    <div class="text-xl font-semibold text-gray-900" x-text="(controlPanelData?.metrics?.requests?.avg_response_time ?? 0).toFixed(3)"></div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-gray-500">Uptime (s)</div>
                                    <div class="text-xl font-semibold text-gray-900" x-text="Math.round(controlPanelData?.metrics?.uptime_seconds ?? 0)"></div>
                                </div>
                            </div>
                            <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-gray-500">Uploaded</div>
                                    <div class="text-base font-semibold text-gray-900" x-text="formatFileSize(controlPanelData?.metrics?.transfer?.upload_bytes || 0)"></div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-gray-500">Downloaded</div>
                                    <div class="text-base font-semibold text-gray-900" x-text="formatFileSize(controlPanelData?.metrics?.transfer?.download_bytes || 0)"></div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Environment</h4>
                            <dl class="space-y-2 text-sm text-gray-700">
                                <div class="flex items-center gap-2">
                                    <dt class="font-medium text-gray-600 w-32">Bind Address</dt>
                                    <dd class="font-mono text-xs" x-text="controlPanelData?.server?.host"></dd>
                                </div>
                                <div class="flex items-center gap-2">
                                    <dt class="font-medium text-gray-600 w-32">Port</dt>
                                    <dd class="font-mono text-xs" x-text="controlPanelData?.server?.port"></dd>
                                </div>
                                <div class="flex items-center gap-2">
                                    <dt class="font-medium text-gray-600 w-32">Scheme</dt>
                                    <dd class="font-mono text-xs" x-text="controlPanelData?.server?.scheme"></dd>
                                </div>
                                <div class="flex items-center gap-2">
                                    <dt class="font-medium text-gray-600 w-32">Platform</dt>
                                    <dd class="font-mono text-xs" x-text="controlPanelData?.environment?.platform"></dd>
                                </div>
                                <div class="flex items-center gap-2">
                                    <dt class="font-medium text-gray-600 w-32">Python</dt>
                                    <dd class="font-mono text-xs" x-text="controlPanelData?.environment?.python_version"></dd>
                                </div>
                                <div class="flex items-center gap-2">
                                    <dt class="font-medium text-gray-600 w-32">Working Dir</dt>
                                    <dd class="font-mono text-xs truncate" x-text="controlPanelData?.environment?.working_directory"></dd>
                                </div>
                            </dl>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <script>
        function fileManager() {
            const initial = window.__CHFS_INITIAL_STATE__ || {};
            const initialRoots = Array.isArray(initial.accessible_roots) ? initial.accessible_roots : [];
            const initialUser = initial.user || '';

            return {
                // Session state
                isAuthenticated: Boolean(initial.authenticated),
                currentUser: initialUser,
                accessibleRoots: initialRoots,
                authHeader: '',
                loginUsername: initialUser,
                loginPassword: '',
                rememberCredentials: true,
                loginError: '',
                loginInfo: '',
                showRegister: false,
                registerUsername: '',
                registerPassword: '',
                registerConfirm: '',
                registerError: '',

                // File browser state
                currentRoot: initialRoots.length > 0 ? initialRoots[0] : '',
                currentPath: '',
                files: [],
                selectedFiles: [],
                loading: false,
                error: null,

                // Modals
                showUpload: false,
                showNewFolder: false,
                showDirectTransfer: false,
                showRename: false,
                showControlPanel: false,
                controlPanelLoading: false,
                controlPanelError: '',
                controlPanelNotice: '',
                controlPanelData: null,
                controlPanelFetchedAt: null,
                customUrlEditor: '',
                customUrlSaving: false,

                // Form data
                uploadFiles: [],
                newFolderName: '',
                renameValue: '',
                renameTarget: null,
                uploading: false,

                // Direct transfer state
                directTransferRecipients: [],
                directTransferRecipientsLoading: false,
                directTransferRecipient: '',
                directTransferFile: null,
                directTransferSending: false,
                directTransferSuccess: '',
                directTransferError: '',
                directTransferListError: '',
                directTransferIncoming: [],
                directTransferOutgoing: [],
                directTransferListLoading: false,
                directTransferTab: 'incoming',

                init() {
                    const savedUser = localStorage.getItem('chfsAuthUser');
                    if (!this.loginUsername && savedUser) {
                        this.loginUsername = savedUser;
                    }

                    this.tryAutoLogin().then((autoLoggedIn) => {
                        if (!autoLoggedIn && this.isAuthenticated && this.currentRoot) {
                            this.loadFiles();
                        }
                    });
                },

                // Computed
                get pathParts() {
                    return this.currentPath ? this.currentPath.split('/').filter(p => p) : [];
                },

                get controlPanelTimestamp() {
                    return this.controlPanelFetchedAt ? new Date(this.controlPanelFetchedAt).toLocaleString() : '';
                },

                buildHeaders(additional = {}) {
                    const headers = { ...additional };
                    if (this.authHeader) {
                        headers['Authorization'] = this.authHeader;
                    }
                    return headers;
                },

                createAuthHeader(username, password) {
                    return 'Basic ' + btoa(`${username}:${password}`);
                },

                clearStoredCredentials() {
                    localStorage.removeItem('chfsAuthHeader');
                    localStorage.removeItem('chfsAuthUser');
                },

                resetCredentials() {
                    this.authHeader = '';
                    this.clearStoredCredentials();
                },

                focusLogin() {
                    this.$nextTick(() => {
                        if (this.$refs.loginUsername) {
                            this.$refs.loginUsername.focus();
                        }
                    });
                },

                switchToRegister() {
                    this.showRegister = true;
                    this.registerUsername = this.loginUsername || '';
                    this.registerPassword = '';
                    this.registerConfirm = '';
                    this.registerError = '';
                    this.loginError = '';
                    this.loginInfo = '';
                    this.$nextTick(() => {
                        if (this.$refs.registerUsername) {
                            this.$refs.registerUsername.focus();
                        }
                    });
                },

                switchToLogin(message = '') {
                    this.showRegister = false;
                    this.registerUsername = '';
                    this.registerPassword = '';
                    this.registerConfirm = '';
                    this.registerError = '';
                    if (message) {
                        this.loginInfo = message;
                        this.loginError = '';
                    } else {
                        this.loginInfo = '';
                    }
                    this.$nextTick(() => this.focusLogin());
                },

                async performRegister() {
                    const username = (this.registerUsername || '').trim();
                    this.registerError = '';
                    this.loginInfo = '';
                    if (!username || username.length < 3) {
                        this.registerError = 'Username must be at least 3 characters.';
                        return;
                    }

                    if (!this.registerPassword || this.registerPassword.length < 6) {
                        this.registerError = 'Password must be at least 6 characters.';
                        return;
                    }

                    if (this.registerPassword !== this.registerConfirm) {
                        this.registerError = 'Passwords do not match.';
                        return;
                    }

                    try {
                        const response = await fetch('/api/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                username,
                                password: this.registerPassword,
                                confirmPassword: this.registerConfirm,
                            }),
                        });

                        const payload = this.parseApiResponse(await response.json());
                        if (response.ok && payload.code === 0) {
                            this.registerError = '';
                            this.loginUsername = username;
                            this.loginPassword = '';
                            this.switchToLogin('Registration successful! Please sign in.');
                        } else {
                            this.registerError = payload?.msg || 'Registration failed.';
                        }
                    } catch (e) {
                        this.registerError = 'Registration failed: ' + e.message;
                    }
                },

                async tryAutoLogin() {
                    const savedHeader = localStorage.getItem('chfsAuthHeader');
                    const savedUser = localStorage.getItem('chfsAuthUser');

                    if (savedUser && !this.loginUsername) {
                        this.loginUsername = savedUser;
                    }

                    if (savedHeader) {
                        this.authHeader = savedHeader;
                        this.rememberCredentials = true;
                        const success = await this.refreshSession(false);
                        if (success) {
                            if (this.currentRoot) {
                                await this.loadFiles();
                            }
                            return true;
                        }
                        this.resetCredentials();
                    }

                    if (!this.isAuthenticated) {
                        this.focusLogin();
                    }

                    return false;
                },

                ensureAuthenticated(showMessage = true) {
                    if (this.isAuthenticated || this.authHeader) {
                        return true;
                    }
                    if (showMessage) {
                        this.loginError = 'Please log in to continue.';
                        this.loginInfo = '';
                        this.focusLogin();
                    }
                    return false;
                },

                async loadControlPanel(force = false) {
                    if (!this.ensureAuthenticated(false)) {
                        return;
                    }
                    if (this.controlPanelLoading) {
                        return;
                    }
                    if (!force && this.controlPanelData) {
                        return;
                    }

                    this.controlPanelLoading = true;
                    this.controlPanelError = '';

                    try {
                        const response = await fetch('/api/admin/status', {
                            headers: this.buildHeaders()
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.controlPanelData = payload.data || {};
                            this.controlPanelFetchedAt = new Date().toISOString();
                            const urls = Array.isArray(this.controlPanelData?.server?.custom_urls)
                                ? this.controlPanelData.server.custom_urls
                                : [];
                            this.customUrlEditor = urls.join('\n');
                            this.customUrlSaving = false;
                        } else {
                            this.controlPanelError = payload.msg || 'Failed to load control panel data.';
                        }
                    } catch (e) {
                        this.controlPanelError = 'Failed to load control panel data: ' + e.message;
                    } finally {
                        this.controlPanelLoading = false;
                    }
                },

                async openControlPanel() {
                    if (!this.ensureAuthenticated()) {
                        return;
                    }
                    this.showControlPanel = true;
                    await this.loadControlPanel(true);
                },

                async refreshControlPanel() {
                    await this.loadControlPanel(true);
                },

                async updateShareQuota(name, payload) {
                    if (!this.ensureAuthenticated(false)) {
                        return;
                    }
                    this.controlPanelError = '';
                    this.controlPanelNotice = '';

                    try {
                        const response = await fetch(`/api/admin/shares/${encodeURIComponent(name)}/quota`, {
                            method: 'PUT',
                            headers: this.buildHeaders({ 'Content-Type': 'application/json' }),
                            body: JSON.stringify(payload || {})
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payloadData = this.parseApiResponse(await response.json());
                        if (response.ok && payloadData.code === 0) {
                            this.controlPanelNotice = `Quota updated for ${name}.`;
                            await this.refreshControlPanel();
                        } else {
                            this.controlPanelError = payloadData?.msg || 'Failed to update share quota.';
                        }
                    } catch (e) {
                        this.controlPanelError = 'Failed to update share quota: ' + e.message;
                    }
                },

                async promptShareQuota(share) {
                    if (!share || !share.name) {
                        return;
                    }
                    const current = share.quota?.limit_display || '';
                    const value = window.prompt('Enter a quota (e.g. 10GB). Leave blank to remove the limit.', current);
                    if (value === null) {
                        return;
                    }
                    const trimmed = value.trim();
                    if (!trimmed) {
                        await this.clearShareQuota(share);
                        return;
                    }
                    await this.updateShareQuota(share.name, { quota: trimmed });
                },

                async clearShareQuota(share) {
                    if (!share || !share.name) {
                        return;
                    }
                    if (!window.confirm(`Remove the quota limit for "${share.name}"?`)) {
                        return;
                    }
                    await this.updateShareQuota(share.name, {});
                },

                async updateServerUrls() {
                    if (!this.ensureAuthenticated(false)) {
                        return;
                    }

                    const entries = (this.customUrlEditor || '').split('\n')
                        .map(line => line.trim())
                        .filter(Boolean);

                    this.customUrlSaving = true;
                    this.controlPanelError = '';
                    this.controlPanelNotice = '';

                    try {
                        const response = await fetch('/api/admin/server/custom-urls', {
                            method: 'PUT',
                            headers: this.buildHeaders({ 'Content-Type': 'application/json' }),
                            body: JSON.stringify({ urls: entries })
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (response.ok && payload.code === 0) {
                            this.controlPanelNotice = 'Server URLs updated.';
                            await this.refreshControlPanel();
                        } else {
                            this.controlPanelError = payload?.msg || 'Failed to update server URLs.';
                        }
                    } catch (e) {
                        this.controlPanelError = 'Failed to update server URLs: ' + e.message;
                    } finally {
                        this.customUrlSaving = false;
                    }
                },

                async removeUser(username) {
                    if (!username) {
                        return;
                    }
                    if (!window.confirm(`Remove user "${username}"?`)) {
                        return;
                    }

                    this.controlPanelError = '';
                    this.controlPanelNotice = '';

                    try {
                        const response = await fetch(`/api/admin/users/${encodeURIComponent(username)}`, {
                            method: 'DELETE',
                            headers: this.buildHeaders()
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (response.ok && payload.code === 0) {
                            this.controlPanelNotice = `Removed user ${username}.`;
                            await this.refreshControlPanel();
                        } else {
                            this.controlPanelError = payload?.msg || 'Failed to remove user.';
                        }
                    } catch (e) {
                        this.controlPanelError = 'Failed to remove user: ' + e.message;
                    }
                },

                closeControlPanel() {
                    this.showControlPanel = false;
                    this.controlPanelNotice = '';
                },

                parseApiResponse(data) {
                    if (data && typeof data === 'object' && 'detail' in data) {
                        return data.detail;
                    }
                    return data;
                },

                async refreshSession(showErrors = true) {
                    if (!this.authHeader) {
                        return false;
                    }

                    try {
                        const response = await fetch('/api/session', {
                            headers: this.buildHeaders()
                        });

                    if (response.status === 401) {
                        if (showErrors) {
                            this.loginError = 'Invalid username or password.';
                            this.loginInfo = '';
                        }
                        this.handleUnauthorized(null);
                        return false;
                    }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.isAuthenticated = true;
                            this.loginError = '';
                            this.loginInfo = '';
                            this.currentUser = payload.data?.user?.name || this.loginUsername;
                            if (!this.loginUsername) {
                                this.loginUsername = this.currentUser;
                            }

                            const roots = Array.isArray(payload.data?.roots) ? payload.data.roots : [];
                            this.accessibleRoots = roots;
                            if (!this.currentRoot || !roots.includes(this.currentRoot)) {
                                this.currentRoot = roots[0] || '';
                                this.currentPath = '';
                            }
                            await this.refreshDirectTransferLists();
                            return true;
                        }

                        if (showErrors) {
                            this.loginError = payload.msg || 'Failed to verify credentials.';
                            this.loginInfo = '';
                        }
                        return false;
                    } catch (e) {
                        if (showErrors) {
                            this.loginError = 'Login failed: ' + e.message;
                            this.loginInfo = '';
                        }
                        return false;
                    }
                },

                async performLogin() {
                    const username = (this.loginUsername || '').trim();
                    if (!username || !this.loginPassword) {
                        this.loginError = 'Please enter username and password.';
                        this.loginInfo = '';
                        this.focusLogin();
                        return false;
                    }

                    try {
                        this.loginUsername = username;
                        this.authHeader = this.createAuthHeader(username, this.loginPassword);
                    } catch (e) {
                        this.loginError = 'Failed to encode credentials.';
                        this.loginInfo = '';
                        return false;
                    }

                    const success = await this.refreshSession(true);
                    if (success) {
                        this.error = null;
                        this.loginPassword = '';
                        this.loginError = '';
                        this.loginInfo = '';

                        if (this.rememberCredentials) {
                            localStorage.setItem('chfsAuthHeader', this.authHeader);
                            localStorage.setItem('chfsAuthUser', this.currentUser);
                        } else {
                            this.clearStoredCredentials();
                        }

                        if (this.currentRoot) {
                            await this.loadFiles();
                        } else {
                            this.files = [];
                            this.selectedFiles = [];
                        }
                    } else {
                        this.resetCredentials();
                    }
                    return success;
                },

                handleUnauthorized(message = 'Session expired. Please log in again.') {
                    this.isAuthenticated = false;
                    this.accessibleRoots = [];
                    this.files = [];
                    this.currentRoot = '';
                    this.currentPath = '';
                    this.selectedFiles = [];
                    this.showUpload = false;
                    this.showNewFolder = false;
                    this.showDirectTransfer = false;
                    this.showRename = false;
                    this.showControlPanel = false;
                    this.uploadFiles = [];
                    this.uploading = false;
                    this.renameTarget = null;
                    this.renameValue = '';
                    this.directTransferRecipients = [];
                    this.directTransferRecipientsLoading = false;
                    this.directTransferRecipient = '';
                    this.directTransferFile = null;
                    this.directTransferSending = false;
                    this.directTransferSuccess = '';
                    this.directTransferError = '';
                    this.directTransferListError = '';
                    this.directTransferIncoming = [];
                    this.directTransferOutgoing = [];
                    this.directTransferListLoading = false;
                    this.directTransferTab = 'incoming';
                    this.controlPanelData = null;
                    this.controlPanelError = '';
                    this.controlPanelFetchedAt = null;
                    this.controlPanelLoading = false;
                    this.customUrlEditor = '';
                    this.customUrlSaving = false;

                    if (message !== null) {
                        this.error = message;
                        this.loginError = message;
                        this.loginInfo = '';
                    }

                    this.resetCredentials();
                    this.focusLogin();
                },

                logout() {
                    this.isAuthenticated = false;
                    this.accessibleRoots = [];
                    this.files = [];
                    this.currentRoot = '';
                    this.currentPath = '';
                    this.selectedFiles = [];
                    this.error = null;
                    this.loginError = '';
                    this.loginPassword = '';
                    this.showUpload = false;
                    this.showNewFolder = false;
                    this.showDirectTransfer = false;
                    this.showRename = false;
                    this.showControlPanel = false;
                    this.uploadFiles = [];
                    this.uploading = false;
                    this.renameTarget = null;
                    this.renameValue = '';
                    this.directTransferRecipients = [];
                    this.directTransferRecipientsLoading = false;
                    this.directTransferRecipient = '';
                    this.directTransferFile = null;
                    this.directTransferSending = false;
                    this.directTransferSuccess = '';
                    this.directTransferError = '';
                    this.directTransferListError = '';
                    this.directTransferIncoming = [];
                    this.directTransferOutgoing = [];
                    this.directTransferListLoading = false;
                    this.directTransferTab = 'incoming';
                    this.controlPanelData = null;
                    this.controlPanelError = '';
                    this.controlPanelFetchedAt = null;
                    this.controlPanelLoading = false;
                    this.customUrlEditor = '';
                    this.customUrlSaving = false;
                    this.resetCredentials();
                    this.focusLogin();
                },

                async loadFiles() {
                    if (!this.currentRoot) {
                        this.files = [];
                        this.selectedFiles = [];
                        return;
                    }

                    if (!this.ensureAuthenticated(false)) {
                        return;
                    }

                    this.loading = true;
                    this.error = null;

                    try {
                        const response = await fetch(`/api/list?root=${encodeURIComponent(this.currentRoot)}&path=${encodeURIComponent(this.currentPath)}`, {
                            headers: this.buildHeaders()
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.files = payload.data?.files || [];
                            this.selectedFiles = [];
                        } else {
                            this.error = payload.msg || 'Failed to load files.';
                        }
                    } catch (e) {
                        this.error = 'Failed to load files: ' + e.message;
                    } finally {
                        this.loading = false;
                    }
                },

                navigateToFolder(path) {
                    this.currentPath = path;
                    this.selectedFiles = [];
                    this.loadFiles();
                },

                navigateUp() {
                    const parts = this.pathParts;
                    parts.pop();
                    this.currentPath = parts.join('/');
                    this.selectedFiles = [];
                    this.loadFiles();
                },

                navigateToPath(index) {
                    const parts = this.pathParts.slice(0, index + 1);
                    this.currentPath = parts.join('/');
                    this.selectedFiles = [];
                    this.loadFiles();
                },

                async downloadFile(file) {
                    if (!file || !file.path) return;
                    if (!this.ensureAuthenticated(false)) return;

                    try {
                        const response = await fetch(`/api/download?root=${encodeURIComponent(this.currentRoot)}&path=${encodeURIComponent(file.path)}`, {
                            headers: this.buildHeaders()
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        if (!response.ok) {
                            throw new Error('Download failed with status ' + response.status);
                        }

                        const blob = await response.blob();
                        let filename = file.name || file.path.split('/').pop() || 'download';
                        const disposition = response.headers.get('content-disposition');
                        if (disposition) {
                            const utfMatch = disposition.match(/filename\*=UTF-8''([^;]+)/i);
                            const asciiMatch = disposition.match(/filename="?([^";]+)"?/i);
                            if (utfMatch) {
                                filename = decodeURIComponent(utfMatch[1]);
                            } else if (asciiMatch) {
                                filename = asciiMatch[1];
                            }
                        }

                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    } catch (e) {
                        alert('Download failed: ' + e.message);
                    }
                },

                async deleteFile(path) {
                    if (!this.ensureAuthenticated()) return;
                    if (!confirm('Are you sure you want to delete this item?')) return;

                    try {
                        const response = await fetch('/api/delete', {
                            method: 'POST',
                            headers: this.buildHeaders({'Content-Type': 'application/json'}),
                            body: JSON.stringify({
                                root: this.currentRoot,
                                paths: [path]
                            })
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.loadFiles();
                        } else {
                            alert('Delete failed: ' + (payload.msg || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Delete failed: ' + e.message);
                    }
                },

                async deleteSelected() {
                    if (!this.ensureAuthenticated()) return;
                    if (this.selectedFiles.length === 0) return;
                    if (!confirm(`Delete ${this.selectedFiles.length} selected items?`)) return;

                    try {
                        const response = await fetch('/api/delete', {
                            method: 'POST',
                            headers: this.buildHeaders({'Content-Type': 'application/json'}),
                            body: JSON.stringify({
                                root: this.currentRoot,
                                paths: this.selectedFiles
                            })
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.selectedFiles = [];
                            this.loadFiles();
                        } else {
                            alert('Delete failed: ' + (payload.msg || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Delete failed: ' + e.message);
                    }
                },

                renameFile(file) {
                    this.renameTarget = file;
                    this.renameValue = file?.name || '';
                    this.showRename = true;
                },

                async confirmRename() {
                    if (!this.ensureAuthenticated()) return;
                    if (!this.renameTarget || !this.renameValue.trim()) return;

                    try {
                        const response = await fetch('/api/rename', {
                            method: 'POST',
                            headers: this.buildHeaders({'Content-Type': 'application/json'}),
                            body: JSON.stringify({
                                root: this.currentRoot,
                                path: this.renameTarget.path,
                                newName: this.renameValue.trim()
                            })
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.showRename = false;
                            this.renameTarget = null;
                            this.renameValue = '';
                            this.loadFiles();
                        } else {
                            alert('Rename failed: ' + (payload.msg || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Rename failed: ' + e.message);
                    }
                },

                async createFolder() {
                    if (!this.ensureAuthenticated()) return;
                    if (!this.newFolderName.trim()) return;

                    try {
                        const response = await fetch('/api/mkdir', {
                            method: 'POST',
                            headers: this.buildHeaders({'Content-Type': 'application/json'}),
                            body: JSON.stringify({
                                root: this.currentRoot,
                                path: this.currentPath ? `${this.currentPath}/${this.newFolderName}` : this.newFolderName
                            })
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.showNewFolder = false;
                            this.newFolderName = '';
                            this.loadFiles();
                        } else {
                            alert('Create folder failed: ' + (payload.msg || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Create folder failed: ' + e.message);
                    }
                },

                handleFileSelect(event) {
                    this.uploadFiles = Array.from(event.target.files);
                },

                handleUploadDrop(event) {
                    event.target.classList.remove('border-blue-500', 'bg-blue-50');
                    this.uploadFiles = Array.from(event.dataTransfer.files);
                },

                handleDrop(event) {
                    event.target.classList.remove('drag-over');
                    this.uploadFiles = Array.from(event.dataTransfer.files);
                    this.showUpload = true;
                },

                async uploadSelectedFiles() {
                    if (!this.ensureAuthenticated()) return;
                    if (this.uploadFiles.length === 0) return;

                    this.uploading = true;

                    try {
                        for (const file of this.uploadFiles) {
                            const formData = new FormData();
                            formData.append('root', this.currentRoot);
                            formData.append('path', this.currentPath);
                            formData.append('file', file);

                            const response = await fetch('/api/upload', {
                                method: 'POST',
                                headers: this.buildHeaders(),
                                body: formData
                            });

                            if (response.status === 401) {
                                this.handleUnauthorized();
                                return;
                            }

                            const payload = this.parseApiResponse(await response.json());
                            if (payload.code !== 0) {
                                alert(`Upload failed for ${file.name}: ${payload.msg || 'Unknown error'}`);
                            }
                        }

                        this.showUpload = false;
                        this.uploadFiles = [];
                        this.loadFiles();

                    } catch (e) {
                        alert('Upload failed: ' + e.message);
                    } finally {
                        this.uploading = false;
                    }
                },

                async openDirectTransfer() {
                    if (!this.ensureAuthenticated()) {
                        return;
                    }
                    this.directTransferError = '';
                    this.directTransferSuccess = '';
                    this.directTransferListError = '';
                    this.directTransferFile = null;
                    this.directTransferTab = 'incoming';
                    this.showDirectTransfer = true;
                    if (this.$refs.directTransferFileInput) {
                        this.$refs.directTransferFileInput.value = '';
                    }
                    await Promise.all([
                        this.loadDirectTransferRecipients(),
                        this.refreshDirectTransferLists(),
                    ]);
                },

                closeDirectTransfer() {
                    this.showDirectTransfer = false;
                    this.directTransferSending = false;
                    this.directTransferRecipientsLoading = false;
                    this.directTransferFile = null;
                    this.directTransferError = '';
                    this.directTransferSuccess = '';
                    this.directTransferListError = '';
                    if (this.$refs.directTransferFileInput) {
                        this.$refs.directTransferFileInput.value = '';
                    }
                },

                handleDirectTransferFile(event) {
                    const files = event?.target?.files;
                    this.directTransferFile = files && files[0] ? files[0] : null;
                },

                async loadDirectTransferRecipients() {
                    if (!this.ensureAuthenticated(false)) {
                        return;
                    }
                    this.directTransferRecipientsLoading = true;
                    try {
                        const response = await fetch('/api/direct-transfer/recipients', {
                            headers: this.buildHeaders(),
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (response.ok && payload.code === 0) {
                            const names = Array.isArray(payload.data?.recipients) ? payload.data.recipients : [];
                            this.directTransferRecipients = names;
                            if (!names.includes(this.directTransferRecipient)) {
                                this.directTransferRecipient = names[0] || '';
                            }
                        } else {
                            this.directTransferListError = payload?.msg || 'Failed to load recipients.';
                        }
                    } catch (e) {
                        this.directTransferListError = 'Failed to load recipients: ' + e.message;
                    } finally {
                        this.directTransferRecipientsLoading = false;
                    }
                },

                async fetchDirectTransferList(direction) {
                    try {
                        const response = await fetch(`/api/direct-transfer/list?direction=${encodeURIComponent(direction)}`, {
                            headers: this.buildHeaders(),
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return [];
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (response.ok && payload.code === 0) {
                            const transfers = Array.isArray(payload.data?.transfers) ? payload.data.transfers : [];
                            return transfers;
                        }

                        throw new Error(payload?.msg || 'Failed to load transfers.');
                    } catch (e) {
                        throw new Error(e.message || 'Failed to load transfers.');
                    }
                },

                async refreshDirectTransferLists() {
                    if (!this.ensureAuthenticated(false)) {
                        this.directTransferIncoming = [];
                        this.directTransferOutgoing = [];
                        return;
                    }
                    this.directTransferListLoading = true;
                    this.directTransferListError = '';
                    try {
                        const [incoming, outgoing] = await Promise.all([
                            this.fetchDirectTransferList('incoming'),
                            this.fetchDirectTransferList('outgoing'),
                        ]);
                        this.directTransferIncoming = incoming;
                        this.directTransferOutgoing = outgoing;
                    } catch (e) {
                        this.directTransferListError = e.message || 'Failed to load transfers.';
                    } finally {
                        this.directTransferListLoading = false;
                    }
                },

                async sendDirectTransfer() {
                    if (!this.ensureAuthenticated()) {
                        return;
                    }
                    if (!this.directTransferRecipient) {
                        this.directTransferError = 'Please choose a recipient.';
                        return;
                    }
                    if (!this.directTransferFile) {
                        this.directTransferError = 'Please select a file to send.';
                        return;
                    }

                    this.directTransferError = '';
                    this.directTransferSuccess = '';
                    this.directTransferSending = true;

                    const formData = new FormData();
                    formData.append('recipient', this.directTransferRecipient);
                    formData.append('file', this.directTransferFile);

                    try {
                        const response = await fetch('/api/direct-transfer/send', {
                            method: 'POST',
                            headers: this.buildHeaders(),
                            body: formData,
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (response.ok && payload.code === 0) {
                            const filename = payload.data?.transfer?.filename || (this.directTransferFile?.name || 'file');
                            this.directTransferSuccess = `Sent ${filename} to ${this.directTransferRecipient}.`;
                            this.directTransferFile = null;
                            if (this.$refs.directTransferFileInput) {
                                this.$refs.directTransferFileInput.value = '';
                            }
                            await this.refreshDirectTransferLists();
                        } else {
                            this.directTransferError = payload?.msg || 'Failed to send transfer.';
                        }
                    } catch (e) {
                        this.directTransferError = 'Failed to send transfer: ' + e.message;
                    } finally {
                        this.directTransferSending = false;
                    }
                },

                async downloadDirectTransfer(item) {
                    if (!item || !item.id) {
                        return;
                    }
                    if (!this.ensureAuthenticated()) {
                        return;
                    }

                    this.directTransferError = '';

                    try {
                        const response = await fetch(`/api/direct-transfer/download/${encodeURIComponent(item.id)}`, {
                            headers: this.buildHeaders(),
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        if (!response.ok) {
                            const payload = this.parseApiResponse(await response.json());
                            this.directTransferError = payload?.msg || 'Failed to download transfer.';
                            return;
                        }

                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = item.filename || 'download';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        this.directTransferSuccess = `Downloaded ${item.filename || 'file'}.`;
                        await this.refreshDirectTransferLists();
                    } catch (e) {
                        this.directTransferError = 'Failed to download transfer: ' + e.message;
                    }
                },

                async deleteDirectTransfer(item, direction = 'incoming') {
                    if (!item || !item.id) {
                        return;
                    }
                    if (!this.ensureAuthenticated()) {
                        return;
                    }

                    this.directTransferError = '';

                    try {
                        const response = await fetch(`/api/direct-transfer/${encodeURIComponent(item.id)}`, {
                            method: 'DELETE',
                            headers: this.buildHeaders(),
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (response.ok && payload.code === 0) {
                            const action = direction === 'outgoing' ? 'Transfer cancelled.' : 'Transfer removed.';
                            this.directTransferSuccess = payload?.msg || action;
                            await this.refreshDirectTransferLists();
                        } else {
                            this.directTransferError = payload?.msg || 'Failed to remove transfer.';
                        }
                    } catch (e) {
                        this.directTransferError = 'Failed to remove transfer: ' + e.message;
                    }
                },

                selectAll() {
                    this.selectedFiles = this.files.map(f => f.path);
                },

                toggleSelectAll() {
                    if (this.selectedFiles.length === this.files.length) {
                        this.selectedFiles = [];
                    } else {
                        this.selectAll();
                    }
                },

                formatFileSize(bytes) {
                    if (!bytes) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                },

                formatDate(timestamp) {
                    if (!timestamp) return '';
                    const date = new Date(timestamp * 1000);
                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                }
            };
        }
    </script>
</body>
</html>
