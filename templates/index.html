<!DOCTYPE html>
<html lang="{{ language }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
        .drag-over { @apply border-blue-500 bg-blue-50; }
        .file-row:hover { @apply bg-gray-50; }
    </style>
    <script>
        window.__CHFS_INITIAL_STATE__ = {{ {
            "authenticated": authenticated,
            "user": user.name if user else "",
            "accessible_roots": accessible_roots,
        } | tojson }};
    </script>
</head>
<body class="bg-[#f6f8fa] min-h-screen text-gray-900">
    <div x-data="fileManager()" x-cloak class="min-h-screen flex flex-col">
        <!-- Global header -->
        <header class="bg-[#24292f] text-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <span class="inline-flex items-center justify-center w-9 h-9 rounded-full bg-white/10">
                        <i class="fab fa-github text-xl"></i>
                    </span>
                    <div>
                        <p class="text-lg font-semibold tracking-tight">{{ brand }}</p>
                        <p class="text-xs text-gray-300">Unified project &amp; file workspace</p>
                    </div>
                    <nav class="hidden lg:flex items-center gap-4 text-sm font-medium ml-6">
                        <button type="button" @click="setSection('dashboard')"
                                :class="currentSection === 'dashboard' ? 'text-white border-b-2 border-white' : 'text-gray-300 hover:text-white'"
                                class="pb-1 transition-colors">
                            Overview
                        </button>
                        <button type="button" @click="setSection('repositories')"
                                :class="currentSection === 'repositories' ? 'text-white border-b-2 border-white' : 'text-gray-300 hover:text-white'"
                                class="pb-1 transition-colors">
                            Repositories
                        </button>
                        <button type="button" @click="setSection('repository')"
                                :class="currentSection === 'repository' ? 'text-white border-b-2 border-white' : 'text-gray-300 hover:text-white'"
                                class="pb-1 transition-colors">
                            Code
                        </button>
                    </nav>
                </div>
                <div class="flex items-center gap-3">
                    <div class="hidden md:block">
                        <input type="text" x-model="repositorySearch" @focus="setSection('repositories')"
                               placeholder="Search repositories"
                               class="bg-[#1f242b] text-white text-sm rounded-lg border border-white/10 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent placeholder:text-gray-400">
                    </div>
                    <template x-if="isAuthenticated">
                        <div class="flex items-center gap-3">
                            <button type="button" @click="setSection('repositories')"
                                    class="hidden sm:inline-flex items-center gap-2 bg-white/10 hover:bg-white/20 px-3 py-2 rounded-lg text-sm font-medium transition">
                                <i class="fas fa-book"></i>
                                <span>Repositories</span>
                            </button>
                            <div class="relative" x-data="{ open: false }">
                                <button type="button" @click="open = !open"
                                        class="flex items-center gap-2 bg-white/10 hover:bg-white/20 px-3 py-2 rounded-lg text-sm transition">
                                    <span class="inline-flex items-center justify-center w-9 h-9 rounded-full bg-blue-500 font-semibold"
                                          x-text="currentUserInitials"></span>
                                    <span class="hidden sm:block" x-text="currentUser || loginUsername || 'User'"></span>
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </button>
                                <div x-show="open" x-transition @click.away="open = false"
                                     class="absolute right-0 mt-2 w-56 bg-white text-gray-900 rounded-lg shadow-lg border border-gray-200 z-50">
                                    <div class="px-4 py-3 border-b border-gray-100">
                                        <p class="text-sm font-semibold" x-text="currentUser || loginUsername || 'Authenticated user'"></p>
                                        <p class="text-xs text-gray-500" x-text="`${repoCount} repositories`"></p>
                                    </div>
                                    <button type="button"
                                            class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center gap-2"
                                            @click="openControlPanel(); open = false;">
                                        <i class="fas fa-sliders-h text-gray-500"></i>
                                        Control panel
                                    </button>
                                    <button type="button"
                                            class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center gap-2"
                                            @click="openDirectTransfer(); open = false;">
                                        <i class="fas fa-paper-plane text-gray-500"></i>
                                        Direct transfer
                                    </button>
                                    <div class="border-t border-gray-100 my-1"></div>
                                    <button type="button"
                                            class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 text-red-600 flex items-center gap-2"
                                            @click="logout(); open = false;">
                                        <i class="fas fa-sign-out-alt"></i>
                                        Sign out
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                    <template x-if="!isAuthenticated">
                        <button type="button" @click="focusLogin()"
                                class="inline-flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-sign-in-alt"></i>
                            <span>Sign in</span>
                        </button>
                    </template>
                </div>
            </div>
        </header>
        <main class="flex-1">
            <div class="max-w-7xl mx-auto px-4 py-6 space-y-6">
                <div x-show="!isAuthenticated" x-cloak class="grid gap-6 lg:grid-cols-2">
                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 space-y-6">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">Welcome back</h2>
                            <p class="text-sm text-gray-500 mt-1">Sign in to access your self-hosted repositories.</p>
                        </div>
                        <div class="bg-blue-50 border border-blue-100 rounded-lg px-4 py-3 text-sm text-blue-700 flex items-start gap-3">
                            <i class="fas fa-lock mt-0.5"></i>
                            <div>
                                <p class="font-medium">Secure workspace</p>
                                <p>Authenticate to manage projects and collaborate just like on GitHub.</p>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <template x-if="!showRegister">
                                <form class="space-y-5" @submit.prevent="performLogin()">
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1" for="login-username">Username</label>
                                            <input id="login-username" x-ref="loginUsername" type="text" x-model="loginUsername" autocomplete="username"
                                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                   placeholder="Enter username" required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1" for="login-password">Password</label>
                                            <input id="login-password" type="password" x-model="loginPassword" autocomplete="current-password"
                                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                   placeholder="Enter password" required>
                                        </div>
                                    </div>
                                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                        <label class="inline-flex items-center gap-2 text-sm text-gray-600">
                                            <input type="checkbox" x-model="rememberCredentials" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            Remember credentials
                                        </label>
                                        <div class="flex items-center gap-3">
                                            <button type="submit"
                                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                                Sign in
                                            </button>
                                            <span class="text-xs text-gray-500 hidden sm:block">Default: admin / admin123</span>
                                        </div>
                                    </div>
                                    <p x-show="loginInfo" x-text="loginInfo" class="text-sm text-green-600"></p>
                                    <p x-show="loginError" x-text="loginError" class="text-sm text-red-600"></p>
                                    <p class="text-sm text-gray-600">
                                        Need an account?
                                        <button type="button" @click="switchToRegister()"
                                                class="text-blue-600 hover:text-blue-700 font-medium">
                                            Create one now
                                        </button>
                                    </p>
                                </form>
                            </template>
                            <template x-if="showRegister">
                                <form class="space-y-5" @submit.prevent="performRegister()">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1" for="register-username">Username</label>
                                            <input id="register-username" x-ref="registerUsername" type="text" x-model="registerUsername" autocomplete="username"
                                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                   placeholder="Choose a username" required>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1" for="register-password">Password</label>
                                            <input id="register-password" type="password" x-model="registerPassword" autocomplete="new-password"
                                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                   placeholder="At least 6 characters" required>
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-gray-700 mb-1" for="register-confirm">Confirm password</label>
                                            <input id="register-confirm" type="password" x-model="registerConfirm" autocomplete="new-password"
                                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                   placeholder="Re-enter password" required>
                                        </div>
                                    </div>
                                    <p x-show="registerError" x-text="registerError" class="text-sm text-red-600"></p>
                                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                        <button type="button" @click="switchToLogin()"
                                                class="text-sm text-gray-600 hover:text-gray-800">
                                            Back to sign in
                                        </button>
                                        <button type="submit"
                                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                                            Create account
                                        </button>
                                    </div>
                                </form>
                            </template>
                        </div>
                    </div>
                    <div class="bg-white border border-dashed border-blue-200 rounded-xl shadow-sm p-6 flex flex-col justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                                <i class="fas fa-diagram-project text-blue-500"></i>
                                Project workspace
                            </h3>
                            <p class="text-sm text-gray-600 mt-2">Organize shared folders as repositories, collaborate with teammates, and manage files with a GitHub-inspired experience.</p>
                            <ul class="mt-4 space-y-3 text-sm text-gray-600">
                                <li class="flex items-start gap-3">
                                    <i class="fas fa-check text-green-500 mt-1"></i>
                                    <span>Repository-style navigation with branches, activity feed, and quick actions.</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <i class="fas fa-check text-green-500 mt-1"></i>
                                    <span>Unified control panel for quotas, users, and direct transfer workflows.</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <i class="fas fa-check text-green-500 mt-1"></i>
                                    <span>Secure access with per-user authentication and audit-friendly history.</span>
                                </li>
                            </ul>
                        </div>
                        <div class="mt-6 bg-blue-50 border border-blue-100 rounded-lg px-4 py-3 text-sm text-blue-700">
                            <p class="font-medium mb-1">Tip</p>
                            <p>Grant access to colleagues via the control panel after signing in, then create repositories by sharing folders.</p>
                        </div>
                    </div>
                </div>
                <div x-show="isAuthenticated" x-cloak class="flex flex-col lg:flex-row gap-6">
                    <aside class="w-full lg:w-72 space-y-6">
                        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-5 space-y-4">
                            <div class="flex items-center justify-between">
                                <h2 class="text-xs font-semibold uppercase tracking-wide text-gray-500">Workspace</h2>
                                <span class="text-xs text-gray-400" x-text="`${repoCount} repos`"></span>
                            </div>
                            <div>
                                <p class="text-xs uppercase text-gray-500">Current repository</p>
                                <p class="text-lg font-semibold text-gray-900" x-text="currentRoot || 'None selected'"></p>
                            </div>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div class="rounded-lg bg-gray-50 px-3 py-2">
                                    <p class="text-xs uppercase text-gray-500">Files</p>
                                    <p class="font-semibold text-gray-800" x-text="activeRepoStats.files"></p>
                                </div>
                                <div class="rounded-lg bg-gray-50 px-3 py-2">
                                    <p class="text-xs uppercase text-gray-500">Folders</p>
                                    <p class="font-semibold text-gray-800" x-text="activeRepoStats.directories"></p>
                                </div>
                                <div class="rounded-lg bg-gray-50 px-3 py-2">
                                    <p class="text-xs uppercase text-gray-500">Size</p>
                                    <p class="font-semibold text-gray-800" x-text="formatFileSize(activeRepoStats.size)"></p>
                                </div>
                                <div class="rounded-lg bg-gray-50 px-3 py-2">
                                    <p class="text-xs uppercase text-gray-500">Updated</p>
                                    <p class="font-semibold text-gray-800" x-text="activeRepoStats.lastUpdated ? formatRelativeTime(activeRepoStats.lastUpdated) : 'Not explored yet'"></p>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 border-t border-gray-100 pt-4">
                                <p>Total workspace size</p>
                                <p class="text-sm font-semibold text-gray-900" x-text="formatFileSize(totalRepositorySize)"></p>
                            </div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-5 space-y-3">
                            <h3 class="text-sm font-semibold text-gray-900 flex items-center gap-2">
                                <i class="fas fa-bolt text-amber-500"></i>
                                Quick actions
                            </h3>
                            <button type="button" @click="showUpload = true"
                                    class="w-full inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-200 hover:border-blue-400 hover:text-blue-600 transition text-sm">
                                <i class="fas fa-upload"></i>
                                Upload files
                            </button>
                            <button type="button" @click="showNewFolder = true"
                                    class="w-full inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-200 hover:border-green-400 hover:text-green-600 transition text-sm">
                                <i class="fas fa-folder-plus"></i>
                                New folder
                            </button>
                            <button type="button" @click="openDirectTransfer()"
                                    class="w-full inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-200 hover:border-orange-400 hover:text-orange-600 transition text-sm">
                                <i class="fas fa-paper-plane"></i>
                                Direct transfer
                            </button>
                            <button type="button" @click="openControlPanel()"
                                    class="w-full inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-200 hover:border-purple-400 hover:text-purple-600 transition text-sm">
                                <i class="fas fa-sliders-h"></i>
                                Control panel
                            </button>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-5">
                            <div class="flex items-center justify-between">
                                <h3 class="text-sm font-semibold text-gray-900">Recent activity</h3>
                                <button type="button" class="text-xs text-blue-600 hover:text-blue-700" @click="setSection('dashboard')">View all</button>
                            </div>
                            <template x-if="activityFeed.length === 0">
                                <p class="text-sm text-gray-500 mt-3">No activity yet. Upload files or create folders to get started.</p>
                            </template>
                            <ul class="mt-3 space-y-3">
                                <template x-for="item in activityFeed.slice(0,6)" :key="item.id">
                                    <li class="flex items-start gap-3 text-sm">
                                        <span class="mt-1 text-gray-400">
                                            <i class="fas fa-circle"></i>
                                        </span>
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between gap-2">
                                                <p class="font-medium text-gray-800" x-text="item.message"></p>
                                                <span class="text-xs text-gray-400" x-text="formatRelativeTime(item.timestamp)"></span>
                                            </div>
                                            <p class="text-xs text-gray-500">
                                                <span class="uppercase tracking-wide mr-1" x-text="item.type"></span>
                                                <span x-text="item.repository ? `in ${item.repository}` : 'workspace'"></span>
                                            </p>
                                        </div>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </aside>
                    <section class="flex-1 space-y-6">
                        <div x-show="currentSection === 'dashboard'" x-cloak class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 space-y-6">
                            <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-4">
                                <div class="rounded-xl border border-gray-200 bg-[#f6f8fa] px-4 py-4">
                                    <p class="text-xs uppercase text-gray-500">Repositories</p>
                                    <p class="text-2xl font-semibold text-gray-900 mt-1" x-text="repoCount"></p>
                                </div>
                                <div class="rounded-xl border border-gray-200 bg-[#f6f8fa] px-4 py-4">
                                    <p class="text-xs uppercase text-gray-500">Tracked files</p>
                                    <p class="text-2xl font-semibold text-gray-900 mt-1" x-text="totalFileCount"></p>
                                </div>
                                <div class="rounded-xl border border-gray-200 bg-[#f6f8fa] px-4 py-4">
                                    <p class="text-xs uppercase text-gray-500">Storage used</p>
                                    <p class="text-2xl font-semibold text-gray-900 mt-1" x-text="formatFileSize(totalRepositorySize)"></p>
                                </div>
                                <div class="rounded-xl border border-gray-200 bg-[#f6f8fa] px-4 py-4">
                                    <p class="text-xs uppercase text-gray-500">Active user</p>
                                    <p class="text-2xl font-semibold text-gray-900 mt-1" x-text="currentUser || loginUsername || '—'"></p>
                                </div>
                            </div>
                            <div class="border-t border-gray-200 pt-6">
                                <div class="flex items-center justify-between gap-3 mb-4">
                                    <h3 class="text-base font-semibold text-gray-900">Timeline</h3>
                                    <div class="flex items-center gap-2 text-sm">
                                        <button type="button" class="text-blue-600 hover:text-blue-700" @click="setSection('repositories')">
                                            Manage repositories
                                        </button>
                                    </div>
                                </div>
                                <template x-if="activityFeed.length === 0">
                                    <p class="text-sm text-gray-500">No activity has been recorded yet.</p>
                                </template>
                                <ul class="space-y-4" x-show="activityFeed.length > 0">
                                    <template x-for="item in activityFeed" :key="`timeline-${item.id}`">
                                        <li class="flex items-start gap-3">
                                            <span class="flex h-8 w-8 items-center justify-center rounded-full bg-blue-100 text-blue-600">
                                                <i class="fas fa-history text-sm"></i>
                                            </span>
                                            <div class="flex-1">
                                                <div class="flex items-center justify-between gap-3">
                                                    <p class="text-sm font-semibold text-gray-800" x-text="item.message"></p>
                                                    <span class="text-xs text-gray-400" x-text="formatRelativeTime(item.timestamp)"></span>
                                                </div>
                                                <p class="text-xs text-gray-500 mt-1">
                                                    <span class="uppercase tracking-wide mr-1" x-text="item.type"></span>
                                                    <span x-text="item.repository ? `in ${item.repository}` : 'workspace activity'"></span>
                                                </p>
                                            </div>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </div>
                        <div x-show="currentSection === 'repositories'" x-cloak class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                            <div class="px-6 py-4 border-b border-gray-200 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                                        <i class="fas fa-book text-gray-400"></i>
                                        Repositories
                                    </h2>
                                    <p class="text-sm text-gray-500">Select a repository to explore files and manage content.</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <select x-model="repositorySort"
                                            class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="name">Sort by name</option>
                                        <option value="updated">Recently active</option>
                                        <option value="size">Largest first</option>
                                    </select>
                                    <button type="button"
                                            class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition"
                                            @click="setSection('repository'); currentRoot && loadFiles();">
                                        <i class="fas fa-code-branch"></i>
                                        Open code view
                                    </button>
                                </div>
                            </div>
                            <div class="divide-y divide-gray-100">
                                <template x-if="filteredRepositories.length === 0">
                                    <div class="px-6 py-12 text-center text-gray-500">
                                        <i class="fas fa-database text-3xl mb-3 text-gray-300"></i>
                                        <p class="text-lg font-semibold">No repositories available</p>
                                        <p class="text-sm mt-1">Use the control panel to configure shared directories.</p>
                                    </div>
                                </template>
                                <template x-for="repo in filteredRepositories" :key="`repo-${repo.name}`">
                                    <div class="px-6 py-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4 hover:bg-gray-50 transition">
                                        <div>
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-book text-gray-400"></i>
                                                <button type="button" class="text-lg font-semibold text-blue-600 hover:text-blue-700" @click="selectRepository(repo.name)" x-text="repo.name"></button>
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium" :class="repo.badgeClass" x-text="repo.badgeLabel"></span>
                                            </div>
                                            <p class="text-sm text-gray-600 mt-1" x-text="repo.description"></p>
                                            <p class="text-xs text-gray-400 mt-1">
                                                Updated <span x-text="repo.stats?.lastUpdated ? formatRelativeTime(repo.stats.lastUpdated) : 'not yet explored'"></span>
                                            </p>
                                        </div>
                                        <div class="flex items-center gap-4 text-sm text-gray-600">
                                            <div class="flex items-center gap-1">
                                                <i class="fas fa-star text-amber-500"></i>
                                                <span x-text="repo.stars"></span>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <i class="fas fa-code-branch text-gray-400"></i>
                                                <span x-text="repo.forks"></span>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <i class="fas fa-eye text-gray-400"></i>
                                                <span x-text="repo.watchers"></span>
                                            </div>
                                            <button type="button"
                                                    class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-300 text-sm hover:border-blue-400 hover:text-blue-600 transition"
                                                    @click="selectRepository(repo.name)">
                                                <i class="fas fa-folder-open"></i>
                                                Open
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <div x-show="currentSection === 'repository'" x-cloak class="space-y-4">
                            <div x-show="!currentRoot" class="bg-white border border-gray-200 rounded-xl shadow-sm px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-database text-3xl mb-3 text-gray-300"></i>
                                <p class="text-lg font-semibold text-gray-900">Select a repository</p>
                                <p class="text-sm mt-2 text-gray-600">Choose a project from the repository list to explore its files.</p>
                                <button type="button"
                                        class="mt-4 inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition"
                                        @click="setSection('repositories')">
                                    <i class="fas fa-book"></i>
                                    Browse repositories
                                </button>
                            </div>
                            <div x-show="currentRoot" class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                                <div class="px-6 py-5 border-b border-gray-200 flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <i class="fas fa-book text-gray-400"></i>
                                            <h2 class="text-xl font-semibold text-gray-900" x-text="currentRoot"></h2>
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium" :class="currentRepo?.badgeClass" x-text="currentRepo?.badgeLabel || 'Workspace'"></span>
                                        </div>
                                        <p class="text-sm text-gray-600 mt-1" x-text="currentRepo?.description || 'Repository details and file listing.'"></p>
                                    </div>
                                    <div class="flex flex-wrap items-center gap-2 text-sm text-gray-600">
                                        <div class="flex items-center gap-1 bg-gray-100 px-3 py-1 rounded-full">
                                            <i class="fas fa-star text-amber-500"></i>
                                            <span x-text="currentRepo?.stars || 0"></span>
                                        </div>
                                        <div class="flex items-center gap-1 bg-gray-100 px-3 py-1 rounded-full">
                                            <i class="fas fa-code-branch text-gray-400"></i>
                                            <span x-text="currentRepo?.forks || 0"></span>
                                        </div>
                                        <div class="flex items-center gap-1 bg-gray-100 px-3 py-1 rounded-full">
                                            <i class="fas fa-eye text-gray-400"></i>
                                            <span x-text="currentRepo?.watchers || 0"></span>
                                        </div>
                                        <button type="button"
                                                class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition"
                                                @click="showUpload = true">
                                            <i class="fas fa-upload"></i>
                                            Upload
                                        </button>
                                        <button type="button"
                                                class="inline-flex items-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg transition"
                                                @click="showNewFolder = true">
                                            <i class="fas fa-folder-plus"></i>
                                            New folder
                                        </button>
                                    </div>
                                </div>
                                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex flex-wrap items-center gap-3">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs uppercase text-gray-500">Branch</span>
                                        <span class="inline-flex items-center gap-1 px-2 py-1 bg-white border border-gray-200 rounded-lg text-sm">
                                            <i class="fas fa-code-branch text-gray-500"></i>
                                            <span x-text="currentRepo?.branch || 'main'"></span>
                                        </span>
                                    </div>
                                    <div class="flex items-center gap-2 text-sm text-gray-600">
                                        <button type="button" class="text-blue-600 hover:text-blue-800 font-medium" @click="navigateToRepoRoot()" x-text="currentRoot"></button>
                                        <template x-for="(part, index) in pathParts" :key="`crumb-${index}`">
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-chevron-right text-gray-400 text-xs"></i>
                                                <button type="button" class="text-blue-600 hover:text-blue-800 font-medium" @click="navigateToPath(index)" x-text="part"></button>
                                            </div>
                                        </template>
                                    </div>
                                    <div class="ml-auto flex items-center gap-2 text-sm">
                                        <label class="text-gray-500">Sort</label>
                                        <select x-model="fileSortOption" @change="setFileSort($event.target.value)"
                                                class="border border-gray-300 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                            <option value="name">Name</option>
                                            <option value="updated">Recently updated</option>
                                            <option value="size">Size</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="px-6 py-3 bg-white border-b border-gray-200 flex flex-wrap items-center gap-3 text-sm text-gray-600" x-show="!loading && !error">
                                    <span x-text="`${files.length} items`"></span>
                                    <template x-if="selectedFiles.length > 0">
                                        <div class="flex items-center gap-3 text-blue-600 font-medium">
                                            <span x-text="`${selectedFiles.length} selected`"></span>
                                            <button type="button" class="inline-flex items-center gap-1 text-red-600 hover:text-red-700" @click="deleteSelected()">
                                                <i class="fas fa-trash"></i>
                                                Delete selected
                                            </button>
                                        </div>
                                    </template>
                                    <button type="button" class="ml-auto text-blue-600 hover:text-blue-700" @click="toggleSelectAll()">Toggle select</button>
                                </div>
                                <div x-show="loading" class="px-6 py-12 text-center text-gray-500" x-cloak>
                                    <i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i>
                                    <p>Loading repository files…</p>
                                </div>
                                <div x-show="error && !loading" class="px-6 py-12 text-center text-red-500" x-cloak>
                                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                    <p class="font-medium" x-text="error"></p>
                                    <button type="button"
                                            class="mt-4 inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition"
                                            @click="loadFiles()">
                                        <i class="fas fa-sync-alt"></i>
                                        Retry
                                    </button>
                                </div>
                                <div x-show="!loading && !error && sortedFiles.length > 0" class="overflow-x-auto">
                                    <div class="divide-y divide-gray-100">
                                        <template x-if="currentPath !== ''">
                                            <div class="px-6 py-3 flex items-center gap-3 text-sm hover:bg-gray-50 transition">
                                                <div class="w-10"></div>
                                                <div class="flex-1">
                                                    <button type="button" class="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-2" @click="navigateUp()">
                                                        <i class="fas fa-level-up-alt text-gray-400"></i>
                                                        <span>..</span>
                                                    </button>
                                                </div>
                                                <div class="hidden lg:block w-40 text-right text-xs text-gray-400">-</div>
                                                <div class="hidden md:block w-48 text-right text-xs text-gray-400">-</div>
                                                <div class="w-20"></div>
                                            </div>
                                        </template>
                                        <template x-for="file in sortedFiles" :key="file.path">
                                            <div class="px-6 py-3 flex items-center gap-3 text-sm hover:bg-gray-50 transition">
                                                <div class="w-10">
                                                    <input type="checkbox" :value="file.path" x-model="selectedFiles"
                                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                </div>
                                                <div class="flex-1 flex flex-col md:flex-row md:items-center md:gap-4">
                                                    <div class="flex items-center gap-2">
                                                        <i :class="file.is_dir ? 'fas fa-folder text-amber-500' : 'fas fa-file-alt text-sky-500'"></i>
                                                        <button type="button" class="text-blue-600 hover:text-blue-800 font-medium"
                                                                @click="file.is_dir ? navigateToFolder(file.path) : downloadFile(file)"
                                                                x-text="file.name"></button>
                                                    </div>
                                                    <div class="hidden md:block text-xs text-gray-500" x-text="file.is_dir ? 'Directory' : (file.mime_type || 'File')"></div>
                                                </div>
                                                <div class="hidden lg:block w-40 text-right text-xs text-gray-500" x-text="file.is_dir ? '-' : formatFileSize(file.size)"></div>
                                                <div class="hidden md:block w-48 text-right text-xs text-gray-500" x-text="formatRelativeTime(file.modified)"></div>
                                                <div class="w-20 flex justify-end">
                                                    <div class="relative" x-data="{ open: false }">
                                                        <button type="button" @click="open = !open"
                                                                class="p-2 rounded-lg text-gray-400 hover:text-gray-600 hover:bg-gray-100">
                                                            <i class="fas fa-ellipsis-h"></i>
                                                        </button>
                                                        <div x-show="open" x-transition @click.away="open = false"
                                                             class="absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded-lg shadow-lg z-40">
                                                            <button type="button"
                                                                    class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center gap-2"
                                                                    @click="open = false; renameFile(file);">
                                                                <i class="fas fa-edit text-gray-500"></i>
                                                                Rename
                                                            </button>
                                                            <button type="button"
                                                                    class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center gap-2"
                                                                    @click="open = false; deleteFile(file);">
                                                                <i class="fas fa-trash text-red-500"></i>
                                                                Delete
                                                            </button>
                                                            <button type="button"
                                                                    class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 flex items-center gap-2"
                                                                    @click="open = false; downloadFile(file);">
                                                                <i class="fas fa-download text-blue-500"></i>
                                                                Download
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                <div x-show="!loading && !error && sortedFiles.length === 0" class="px-6 py-12 text-center text-gray-500" x-cloak>
                                    <i class="fas fa-box-open text-4xl mb-3 text-gray-300"></i>
                                    <p class="text-lg font-semibold text-gray-900">Repository is empty</p>
                                    <p class="text-sm text-gray-600">Upload files or create a folder to start building this project.</p>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>
        <!-- Upload Modal -->
        <div x-show="showUpload" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6" @click.away="showUpload = false">
                <h3 class="text-lg font-semibold mb-4">Upload Files</h3>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center"
                     @drop.prevent="handleUploadDrop"
                     @dragover.prevent="$el.classList.add('border-blue-500', 'bg-blue-50')"
                     @dragleave.prevent="$el.classList.remove('border-blue-500', 'bg-blue-50')">
                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                    <p class="text-gray-600 mb-2">Drop files here or click to select</p>
                    <input type="file" multiple @change="handleFileSelect" class="hidden" x-ref="fileInput">
                    <button @click="$refs.fileInput.click()" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        Select Files
                    </button>
                </div>
                <div x-show="uploadFiles.length > 0" class="mt-4">
                    <h4 class="font-medium mb-2">Selected Files:</h4>
                    <template x-for="file in uploadFiles" :key="file.name">
                        <div class="flex justify-between items-center py-1 text-sm">
                            <span x-text="file.name" class="truncate"></span>
                            <span x-text="formatFileSize(file.size)" class="text-gray-500 ml-2"></span>
                        </div>
                    </template>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button @click="showUpload = false" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Cancel
                    </button>
                    <button @click="uploadFiles.length > 0 && uploadSelectedFiles()" 
                            :disabled="uploadFiles.length === 0 || uploading"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors">
                        <span x-show="!uploading">Upload</span>
                        <span x-show="uploading">Uploading...</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- New Folder Modal -->
        <div x-show="showNewFolder" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6" @click.away="showNewFolder = false">
                <h3 class="text-lg font-semibold mb-4">Create New Folder</h3>
                <input type="text" x-model="newFolderName" placeholder="Folder name" 
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       @keyup.enter="createFolder()">
                <div class="flex justify-end gap-3 mt-6">
                    <button @click="showNewFolder = false" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Cancel
                    </button>
                    <button @click="createFolder()" 
                            :disabled="!newFolderName.trim()"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors">
                        Create
                    </button>
                </div>
            </div>
        </div>

        <!-- Direct Transfer Modal -->
        <div x-show="showDirectTransfer" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-3xl w-full p-6 space-y-4" @click.away="closeDirectTransfer()">
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Direct Transfer</h3>
                        <p class="text-sm text-gray-500">Send files directly to another user on this server.</p>
                    </div>
                    <button @click="closeDirectTransfer()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div x-show="directTransferSuccess" class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg" x-text="directTransferSuccess"></div>
                <div x-show="directTransferError" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg" x-text="directTransferError"></div>
                <div x-show="directTransferListError" class="bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded-lg" x-text="directTransferListError"></div>

                <form class="space-y-4" @submit.prevent="sendDirectTransfer()">
                    <div class="grid gap-4 md:grid-cols-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Recipient</label>
                            <select x-model="directTransferRecipient"
                                    :disabled="directTransferRecipientsLoading || directTransferRecipients.length === 0"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                <option value="" disabled>Select recipient</option>
                                <template x-for="recipient in directTransferRecipients" :key="`recipient-${recipient}`">
                                    <option :value="recipient" x-text="recipient"></option>
                                </template>
                            </select>
                            <p x-show="directTransferRecipientsLoading" class="text-xs text-gray-500 mt-1">Loading users…</p>
                            <p x-show="!directTransferRecipientsLoading && directTransferRecipients.length === 0" class="text-xs text-gray-500 mt-1">No other users are currently available.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">File</label>
                            <input type="file" @change="handleDirectTransferFile($event)" x-ref="directTransferFileInput"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            <p x-show="directTransferFile" class="text-xs text-gray-600 mt-2 flex items-center gap-2">
                                <span class="font-medium" x-text="directTransferFile?.name"></span>
                                <span x-text="formatFileSize(directTransferFile?.size || 0)" class="text-gray-500"></span>
                            </p>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" @click="closeDirectTransfer()" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">Cancel</button>
                        <button type="submit"
                                :disabled="directTransferSending || !directTransferRecipient || !directTransferFile"
                                class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg disabled:opacity-50 transition-colors">
                            <span x-show="!directTransferSending">Send</span>
                            <span x-show="directTransferSending">Sending…</span>
                        </button>
                    </div>
                </form>

                <div class="border-t border-gray-200 pt-4">
                    <div class="flex flex-wrap items-center gap-3 mb-4">
                        <div class="flex gap-2">
                            <button type="button"
                                    @click="directTransferTab = 'incoming'"
                                    :class="directTransferTab === 'incoming' ? 'bg-orange-600 text-white' : 'bg-gray-200 text-gray-700'"
                                    class="px-3 py-1 rounded-lg text-sm font-medium transition-colors">
                                Incoming
                            </button>
                            <button type="button"
                                    @click="directTransferTab = 'outgoing'"
                                    :class="directTransferTab === 'outgoing' ? 'bg-orange-600 text-white' : 'bg-gray-200 text-gray-700'"
                                    class="px-3 py-1 rounded-lg text-sm font-medium transition-colors">
                                Sent
                            </button>
                        </div>
                        <button type="button" @click="refreshDirectTransferLists()"
                                class="ml-auto bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-sm transition-colors">
                            Refresh
                        </button>
                    </div>

                    <div x-show="directTransferListLoading" class="bg-blue-50 border border-blue-100 text-blue-700 px-4 py-3 rounded-lg">
                        <i class="fas fa-circle-notch fa-spin mr-2"></i>
                        Loading transfers…
                    </div>

                    <div x-show="!directTransferListLoading && directTransferTab === 'incoming'" class="space-y-3">
                        <template x-if="directTransferIncoming.length > 0">
                            <ul class="space-y-3">
                                <template x-for="item in directTransferIncoming" :key="`incoming-${item.id}`">
                                    <li class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                            <div>
                                                <p class="font-medium text-gray-800" x-text="item.filename"></p>
                                                <p class="text-sm text-gray-600">
                                                    From <span class="font-semibold" x-text="item.sender"></span>
                                                    • <span x-text="formatFileSize(item.size)"></span>
                                                    • <span x-text="formatDate(item.createdAt)"></span>
                                                    <span x-show="item.expiresAt" class="ml-2 text-orange-600">
                                                        Expires <span x-text="formatDate(item.expiresAt)"></span>
                                                    </span>
                                                </p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button @click="downloadDirectTransfer(item)"
                                                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                                                    Download
                                                </button>
                                                <button @click="deleteDirectTransfer(item, 'incoming')"
                                                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm transition-colors">
                                                    Decline
                                                </button>
                                            </div>
                                        </div>
                                    </li>
                                </template>
                            </ul>
                        </template>
                        <p x-show="directTransferIncoming.length === 0" class="text-sm text-gray-500">No incoming transfers.</p>
                    </div>

                    <div x-show="!directTransferListLoading && directTransferTab === 'outgoing'" class="space-y-3">
                        <template x-if="directTransferOutgoing.length > 0">
                            <ul class="space-y-3">
                                <template x-for="item in directTransferOutgoing" :key="`outgoing-${item.id}`">
                                    <li class="border border-gray-200 rounded-lg p-4">
                                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                            <div>
                                                <p class="font-medium text-gray-800" x-text="item.filename"></p>
                                                <p class="text-sm text-gray-600">
                                                    To <span class="font-semibold" x-text="item.recipient"></span>
                                                    • <span x-text="formatFileSize(item.size)"></span>
                                                    • <span x-text="formatDate(item.createdAt)"></span>
                                                    <span x-show="item.expiresAt" class="ml-2 text-orange-600">
                                                        Expires <span x-text="formatDate(item.expiresAt)"></span>
                                                    </span>
                                                </p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button @click="deleteDirectTransfer(item, 'outgoing')"
                                                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-lg text-sm transition-colors">
                                                    Cancel
                                                </button>
                                            </div>
                                        </div>
                                    </li>
                                </template>
                            </ul>
                        </template>
                        <p x-show="directTransferOutgoing.length === 0" class="text-sm text-gray-500">No pending sent transfers.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rename Modal -->
        <div x-show="showRename" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6" @click.away="showRename = false">
                <h3 class="text-lg font-semibold mb-4">Rename</h3>
                <input type="text" x-model="renameValue" placeholder="New name"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       @keyup.enter="confirmRename()">
                <div class="flex justify-end gap-3 mt-6">
                    <button @click="showRename = false" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                        Cancel
                    </button>
                    <button @click="confirmRename()"
                            :disabled="!renameValue.trim()"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors">
                        Rename
                    </button>
                </div>
            </div>
        </div>

        <!-- Control Panel Modal -->
        <div x-show="showControlPanel" @keydown.escape.window="closeControlPanel()"
             class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
            <div class="bg-white rounded-lg shadow-2xl max-w-5xl w-full p-6 overflow-hidden" @click.away="closeControlPanel()">
                <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-4">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900">Server Control Panel</h3>
                        <p class="text-sm text-gray-500 mt-1">
                            <span x-show="controlPanelTimestamp" x-text="'Last updated: ' + controlPanelTimestamp"></span>
                            <span x-show="!controlPanelTimestamp">Load the latest status to view live metrics.</span>
                        </p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button @click="refreshControlPanel()"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                            <i class="fas fa-rotate"></i>
                            <span>Refresh</span>
                        </button>
                        <button @click="closeControlPanel()"
                                class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-colors">
                            Close
                        </button>
                    </div>
                </div>

                <div x-show="controlPanelLoading"
                     class="flex items-center gap-2 bg-blue-50 border border-blue-100 text-blue-700 px-4 py-3 rounded-lg mb-4">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    <span>Loading latest server information…</span>
                </div>

                <div x-show="controlPanelError"
                     class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4"
                     x-text="controlPanelError"></div>

                <div x-show="controlPanelNotice"
                     class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-4"
                     x-text="controlPanelNotice"></div>

                <div x-show="!controlPanelLoading && controlPanelData" class="space-y-6 max-h-[70vh] overflow-y-auto pr-1">
                    <section class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-800">Quick LAN Access</h4>
                                <p class="text-sm text-gray-600">Share these URLs with other devices on your network.</p>
                            </div>
                            <span class="text-xs font-semibold px-3 py-1 rounded-full"
                                  :class="(controlPanelData?.ip_filter?.lan_allowed ?? false) ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                                <span x-text="(controlPanelData?.ip_filter?.lan_allowed ?? false) ? 'LAN Reachable' : 'LAN Restricted'"></span>
                            </span>
                        </div>
                        <ul class="space-y-2">
                            <template x-for="url in (controlPanelData?.server?.lan_urls || [])" :key="url">
                                <li class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 bg-white border border-gray-200 rounded-lg px-3 py-2">
                                    <span class="text-sm font-mono text-gray-800 truncate" x-text="url"></span>
                                    <a :href="url" target="_blank" rel="noopener"
                                       class="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center gap-1">
                                        <i class="fas fa-arrow-up-right-from-square"></i>
                                        Open
                                    </a>
                                </li>
                            </template>
                            <li x-show="(controlPanelData?.server?.lan_urls || []).length === 0"
                                class="text-sm text-gray-500">
                                No LAN addresses detected. The server currently binds to
                                <span class="font-mono" x-text="controlPanelData?.server?.host"></span>.
                            </li>
                        </ul>
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                                <div>
                                    <h5 class="text-base font-semibold text-gray-800">Custom URLs</h5>
                                    <p class="text-sm text-gray-600">Provide external URLs to share with people outside your LAN.</p>
                                </div>
                                <span class="text-xs text-gray-500" x-text="`${(controlPanelData?.server?.custom_urls || []).length} configured`"></span>
                            </div>
                            <ul class="mt-3 space-y-2" x-show="(controlPanelData?.server?.custom_urls || []).length">
                                <template x-for="url in (controlPanelData?.server?.custom_urls || [])" :key="`custom-${url}`">
                                    <li class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 bg-white border border-gray-200 rounded-lg px-3 py-2">
                                        <span class="text-sm font-mono text-gray-800 truncate" x-text="url"></span>
                                        <a :href="url" target="_blank" rel="noopener"
                                           class="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center gap-1">
                                            <i class="fas fa-arrow-up-right-from-square"></i>
                                            Open
                                        </a>
                                    </li>
                                </template>
                            </ul>
                            <p x-show="!(controlPanelData?.server?.custom_urls || []).length" class="text-sm text-gray-500 mt-2">
                                No custom URLs configured yet.
                            </p>
                            <label class="block text-sm font-medium text-gray-700 mt-4 mb-1" for="custom-url-editor">Modify custom URLs</label>
                            <textarea id="custom-url-editor" x-model="customUrlEditor" rows="3"
                                      placeholder="https://example.com\nhttps://share.example.net:8443"
                                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm"></textarea>
                            <div class="flex items-center gap-3 mt-2">
                                <button @click="updateServerUrls()"
                                        :disabled="customUrlSaving"
                                        class="bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-4 py-2 rounded-lg transition-colors">
                                    <span x-show="!customUrlSaving">Save URLs</span>
                                    <span x-show="customUrlSaving" class="flex items-center gap-2">
                                        <i class="fas fa-circle-notch fa-spin"></i>
                                        Saving…
                                    </span>
                                </button>
                                <span class="text-xs text-gray-500">One URL per line. Only http/https links are accepted.</span>
                            </div>
                        </div>
                    </section>

                    <section class="grid md:grid-cols-2 gap-4">
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">IP Filter Configuration</h4>
                            <p class="text-sm text-gray-600 mb-3">
                                Mode:
                                <span class="font-medium text-gray-800" x-text="controlPanelData?.ip_filter?.mode || 'unknown'"></span>
                            </p>
                            <div class="space-y-2 text-sm text-gray-700">
                                <div class="font-medium text-gray-700">Allow rules (<span x-text="controlPanelData?.ip_filter?.allow_count ?? 0"></span>)</div>
                                <ul class="list-disc list-inside" x-show="(controlPanelData?.ip_filter?.allow || []).length">
                                    <template x-for="rule in controlPanelData?.ip_filter?.allow" :key="`allow-${rule}`">
                                        <li x-text="rule"></li>
                                    </template>
                                </ul>
                                <p x-show="!(controlPanelData?.ip_filter?.allow || []).length" class="text-gray-500">
                                    No explicit allow rules; all addresses are permitted unless denied.
                                </p>
                            </div>
                            <div class="mt-4 space-y-2 text-sm text-gray-700">
                                <div class="font-medium text-gray-700">Deny rules (<span x-text="controlPanelData?.ip_filter?.deny_count ?? 0"></span>)</div>
                                <ul class="list-disc list-inside" x-show="(controlPanelData?.ip_filter?.deny || []).length">
                                    <template x-for="rule in controlPanelData?.ip_filter?.deny" :key="`deny-${rule}`">
                                        <li x-text="rule"></li>
                                    </template>
                                </ul>
                                <p x-show="!(controlPanelData?.ip_filter?.deny || []).length" class="text-gray-500">
                                    No deny rules are configured.
                                </p>
                            </div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-4 space-y-2">
                            <h4 class="font-semibold text-gray-800">LAN Reachability Details</h4>
                            <p class="text-sm text-gray-600" x-show="controlPanelData?.ip_filter?.lan_allowed">
                                Private network traffic is currently allowed. These rules grant access:
                            </p>
                            <ul class="list-disc list-inside text-sm text-gray-700"
                                x-show="(controlPanelData?.ip_filter?.lan_allowing_rules || []).length">
                                <template x-for="rule in controlPanelData?.ip_filter?.lan_allowing_rules" :key="`lan-allow-${rule}`">
                                    <li x-text="rule"></li>
                                </template>
                            </ul>
                            <p class="text-sm text-red-600" x-show="!(controlPanelData?.ip_filter?.lan_allowed)">
                                Private networks are blocked by the current rules. Add your LAN ranges to the allow list or remove blocking entries.
                            </p>
                            <ul class="list-disc list-inside text-sm text-red-600"
                                x-show="(controlPanelData?.ip_filter?.lan_blocking_rules || []).length">
                                <template x-for="rule in controlPanelData?.ip_filter?.lan_blocking_rules" :key="`lan-block-${rule}`">
                                    <li x-text="rule"></li>
                                </template>
                            </ul>
                        </div>
                    </section>

                    <section class="bg-white border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-semibold text-gray-800">Shares</h4>
                            <span class="text-xs text-gray-500" x-text="`Configured: ${(controlPanelData?.shares || []).length}`"></span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-3 py-2 text-left font-medium text-gray-600">Name</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-600">Path</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-600">Status</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-600">Disk</th>
                                        <th class="px-3 py-2 text-left font-medium text-gray-600">Storage</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <template x-for="share in (controlPanelData?.shares || [])" :key="share.name">
                                        <tr>
                                            <td class="px-3 py-2 font-medium text-gray-800" x-text="share.name"></td>
                                            <td class="px-3 py-2 font-mono text-xs text-gray-600 truncate" x-text="share.path"></td>
                                            <td class="px-3 py-2">
                                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold"
                                                      :class="share.exists ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                                                    <i :class="share.exists ? 'fas fa-check' : 'fas fa-triangle-exclamation'"></i>
                                                    <span x-text="share.exists ? 'Available' : 'Missing'"></span>
                                                </span>
                                                <div class="text-xs text-gray-500 mt-1 flex items-center gap-2">
                                                    <span :class="share.readable ? 'text-green-600' : 'text-red-600'">
                                                        <i class="fas fa-eye"></i>
                                                        <span x-text="share.readable ? 'readable' : 'no read access'"></span>
                                                    </span>
                                                    <span class="text-gray-400">•</span>
                                                    <span :class="share.writable ? 'text-green-600' : 'text-red-600'">
                                                        <i class="fas fa-pen"></i>
                                                        <span x-text="share.writable ? 'writable' : 'read-only'"></span>
                                                    </span>
                                                </div>
                                            </td>
                                            <td class="px-3 py-2 text-xs text-gray-600">
                                                <template x-if="share.disk">
                                                    <div class="space-y-1">
                                                        <div>
                                                            <span class="font-medium text-gray-700">Total:</span>
                                                            <span x-text="formatFileSize(share.disk.total)"></span>
                                                        </div>
                                                        <div>
                                                            <span class="font-medium text-gray-700">Free:</span>
                                                            <span x-text="formatFileSize(share.disk.free)"></span>
                                                        </div>
                                                    </div>
                                                </template>
                                                <p x-show="!share.disk" class="text-gray-400">Disk usage unavailable</p>
                                            </td>
                                            <td class="px-3 py-2 text-xs text-gray-700 space-y-2">
                                                <div>
                                                    <span class="font-medium text-gray-700">Used:</span>
                                                    <span x-text="share.usage?.display || '0 B'"></span>
                                                </div>
                                                <template x-if="share.quota_enabled">
                                                    <div class="space-y-1">
                                                        <div>
                                                            <span class="font-medium text-gray-700">Limit:</span>
                                                            <span x-text="share.quota?.limit_display || '—'"></span>
                                                        </div>
                                                        <div>
                                                            <span class="font-medium text-gray-700">Remaining:</span>
                                                            <span x-text="share.quota?.remaining_display || '0 B'"></span>
                                                        </div>
                                                        <div>
                                                            <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                                                                <div class="h-2" :class="share.quota?.over ? 'bg-red-500' : 'bg-blue-600'"
                                                                     :style="`width: ${Math.min(share.quota?.percent_used ?? 0, 100)}%`"></div>
                                                            </div>
                                                            <div class="text-[10px] text-gray-500 mt-1">
                                                                <span x-text="(share.quota?.percent_used ?? 0).toFixed(1)"></span>% used
                                                            </div>
                                                        </div>
                                                    </div>
                                                </template>
                                                <p x-show="!share.quota_enabled" class="text-gray-400">No quota limit</p>
                                                <div class="flex flex-wrap gap-2 pt-1">
                                                    <button @click="promptShareQuota(share)"
                                                            class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors">
                                                        Set quota
                                                    </button>
                                                    <button x-show="share.quota_enabled"
                                                            @click="clearShareQuota(share)"
                                                            class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors">
                                                        Remove limit
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                    <tr x-show="(controlPanelData?.shares || []).length === 0">
                                        <td colspan="5" class="px-3 py-4 text-center text-gray-500">No shares configured.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <section class="bg-white border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-semibold text-gray-800">User Accounts</h4>
                            <span class="text-xs text-gray-500"
                                  x-text="`Total: ${(controlPanelData?.users || []).length}`"></span>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">
                            Users registered via the control panel can be removed from here. Accounts defined in
                            the configuration file are read-only.
                        </p>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead>
                                    <tr class="text-left text-gray-600 border-b border-gray-200">
                                        <th class="px-3 py-2">Username</th>
                                        <th class="px-3 py-2">Source</th>
                                        <th class="px-3 py-2">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100">
                                    <template x-for="user in (controlPanelData?.users || [])" :key="user.name">
                                        <tr>
                                            <td class="px-3 py-2 font-medium text-gray-800" x-text="user.name"></td>
                                            <td class="px-3 py-2">
                                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs"
                                                      :class="user.dynamic ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'">
                                                    <i :class="user.dynamic ? 'fas fa-user-plus' : 'fas fa-file-lines'"></i>
                                                    <span x-text="user.dynamic ? 'Dynamic' : 'Config file'"></span>
                                                </span>
                                            </td>
                                            <td class="px-3 py-2">
                                                <button x-show="user.dynamic"
                                                        @click="removeUser(user.name)"
                                                        class="text-xs px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors">
                                                    Remove
                                                </button>
                                                <span x-show="!user.dynamic" class="text-xs text-gray-400">Managed externally</span>
                                            </td>
                                        </tr>
                                    </template>
                                    <tr x-show="!(controlPanelData?.users || []).length">
                                        <td colspan="3" class="px-3 py-4 text-center text-gray-500">No users available.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <section class="grid md:grid-cols-2 gap-4">
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Traffic &amp; Performance</h4>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-gray-500">Total Requests</div>
                                    <div class="text-xl font-semibold text-gray-900" x-text="controlPanelData?.metrics?.requests?.total ?? 0"></div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-gray-500">Active Requests</div>
                                    <div class="text-xl font-semibold text-gray-900" x-text="controlPanelData?.metrics?.requests?.active ?? 0"></div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-gray-500">Avg Response (s)</div>
                                    <div class="text-xl font-semibold text-gray-900" x-text="(controlPanelData?.metrics?.requests?.avg_response_time ?? 0).toFixed(3)"></div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-gray-500">Uptime (s)</div>
                                    <div class="text-xl font-semibold text-gray-900" x-text="Math.round(controlPanelData?.metrics?.uptime_seconds ?? 0)"></div>
                                </div>
                            </div>
                            <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-gray-500">Uploaded</div>
                                    <div class="text-base font-semibold text-gray-900" x-text="formatFileSize(controlPanelData?.metrics?.transfer?.upload_bytes || 0)"></div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-gray-500">Downloaded</div>
                                    <div class="text-base font-semibold text-gray-900" x-text="formatFileSize(controlPanelData?.metrics?.transfer?.download_bytes || 0)"></div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">Environment</h4>
                            <dl class="space-y-2 text-sm text-gray-700">
                                <div class="flex items-center gap-2">
                                    <dt class="font-medium text-gray-600 w-32">Bind Address</dt>
                                    <dd class="font-mono text-xs" x-text="controlPanelData?.server?.host"></dd>
                                </div>
                                <div class="flex items-center gap-2">
                                    <dt class="font-medium text-gray-600 w-32">Port</dt>
                                    <dd class="font-mono text-xs" x-text="controlPanelData?.server?.port"></dd>
                                </div>
                                <div class="flex items-center gap-2">
                                    <dt class="font-medium text-gray-600 w-32">Scheme</dt>
                                    <dd class="font-mono text-xs" x-text="controlPanelData?.server?.scheme"></dd>
                                </div>
                                <div class="flex items-center gap-2">
                                    <dt class="font-medium text-gray-600 w-32">Platform</dt>
                                    <dd class="font-mono text-xs" x-text="controlPanelData?.environment?.platform"></dd>
                                </div>
                                <div class="flex items-center gap-2">
                                    <dt class="font-medium text-gray-600 w-32">Python</dt>
                                    <dd class="font-mono text-xs" x-text="controlPanelData?.environment?.python_version"></dd>
                                </div>
                                <div class="flex items-center gap-2">
                                    <dt class="font-medium text-gray-600 w-32">Working Dir</dt>
                                    <dd class="font-mono text-xs truncate" x-text="controlPanelData?.environment?.working_directory"></dd>
                                </div>
                            </dl>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <script>
        function fileManager() {
            const initial = window.__CHFS_INITIAL_STATE__ || {};
            const initialRoots = Array.isArray(initial.accessible_roots) ? initial.accessible_roots : [];
            const initialUser = initial.user || '';

            return {
                // Session state
                isAuthenticated: Boolean(initial.authenticated),
                currentUser: initialUser,
                accessibleRoots: initialRoots,
                authHeader: '',
                loginUsername: initialUser,
                loginPassword: '',
                rememberCredentials: true,
                loginError: '',
                loginInfo: '',
                showRegister: false,
                registerUsername: '',
                registerPassword: '',
                registerConfirm: '',
                registerError: '',

                // File browser state
                currentRoot: '',
                currentPath: '',
                files: [],
                selectedFiles: [],
                loading: false,
                error: null,

                // Project workspace state
                currentSection: 'repositories',
                repositories: [],
                repositorySearch: '',
                repositorySort: 'name',
                fileSortOption: 'name',
                activityFeed: [],
                activeRepoStats: { files: 0, directories: 0, size: 0, lastUpdated: null },

                // Modals
                showUpload: false,
                showNewFolder: false,
                showDirectTransfer: false,
                showRename: false,
                showControlPanel: false,
                controlPanelLoading: false,
                controlPanelError: '',
                controlPanelNotice: '',
                controlPanelData: null,
                controlPanelFetchedAt: null,
                customUrlEditor: '',
                customUrlSaving: false,

                // Form data
                uploadFiles: [],
                newFolderName: '',
                renameValue: '',
                renameTarget: null,
                uploading: false,

                // Direct transfer state
                directTransferRecipients: [],
                directTransferRecipientsLoading: false,
                directTransferRecipient: '',
                directTransferFile: null,
                directTransferSending: false,
                directTransferSuccess: '',
                directTransferError: '',
                directTransferListError: '',
                directTransferIncoming: [],
                directTransferOutgoing: [],
                directTransferListLoading: false,
                directTransferTab: 'incoming',

                init() {
                    this.buildRepositoryCatalog(initialRoots);
                    if (initialRoots.length > 0) {
                        this.currentSection = 'repositories';
                    }

                    const savedUser = localStorage.getItem('chfsAuthUser');
                    if (!this.loginUsername && savedUser) {
                        this.loginUsername = savedUser;
                    }

                    this.tryAutoLogin().then((autoLoggedIn) => {
                        if (!autoLoggedIn && this.isAuthenticated && this.currentRoot) {
                            this.loadFiles();
                        }
                    });
                },

                // Computed
                get pathParts() {
                    return this.currentPath ? this.currentPath.split('/').filter(p => p) : [];
                },

                get controlPanelTimestamp() {
                    return this.controlPanelFetchedAt ? new Date(this.controlPanelFetchedAt).toLocaleString() : '';
                },

                get currentRepo() {
                    return this.repositories.find(repo => repo.name === this.currentRoot) || null;
                },

                get currentUserInitials() {
                    if (!this.currentUser) {
                        return 'NA';
                    }
                    const initials = this.currentUser
                        .split(/\s+/)
                        .filter(Boolean)
                        .map(part => part[0]?.toUpperCase() || '')
                        .join('');
                    return (initials || this.currentUser[0] || 'U').toUpperCase().slice(0, 2);
                },

                get sortedFiles() {
                    const allFiles = Array.isArray(this.files) ? [...this.files] : [];
                    const sortMode = this.fileSortOption;
                    const directories = allFiles.filter(item => item.is_dir);
                    const regularFiles = allFiles.filter(item => !item.is_dir);

                    const compareByName = (a, b) => (a.name || '').localeCompare(b.name || '', undefined, { sensitivity: 'base' });
                    const compareByModified = (a, b) => (b.modified || 0) - (a.modified || 0);
                    const compareBySize = (a, b) => (b.size || 0) - (a.size || 0);

                    let sorter = compareByName;
                    if (sortMode === 'updated') {
                        sorter = compareByModified;
                    } else if (sortMode === 'size') {
                        sorter = compareBySize;
                    }

                    directories.sort(sorter);
                    regularFiles.sort(sorter);
                    return [...directories, ...regularFiles];
                },

                get filteredRepositories() {
                    const term = (this.repositorySearch || '').toLowerCase();
                    let repos = [...this.repositories];
                    if (term) {
                        repos = repos.filter(repo =>
                            repo.name.toLowerCase().includes(term) ||
                            (repo.description || '').toLowerCase().includes(term)
                        );
                    }

                    if (this.repositorySort === 'updated') {
                        repos.sort((a, b) => (b.stats?.lastUpdated || 0) - (a.stats?.lastUpdated || 0));
                    } else if (this.repositorySort === 'size') {
                        repos.sort((a, b) => (b.stats?.size || 0) - (a.stats?.size || 0));
                    } else {
                        repos.sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));
                    }

                    return repos;
                },

                get repoCount() {
                    return this.repositories.length;
                },

                get totalFileCount() {
                    return this.repositories.reduce((acc, repo) => acc + (repo.stats?.files || 0), 0);
                },

                get totalRepositorySize() {
                    return this.repositories.reduce((acc, repo) => acc + (repo.stats?.size || 0), 0);
                },

                buildHeaders(additional = {}) {
                    const headers = { ...additional };
                    if (this.authHeader) {
                        headers['Authorization'] = this.authHeader;
                    }
                    return headers;
                },

                createAuthHeader(username, password) {
                    return 'Basic ' + btoa(`${username}:${password}`);
                },

                clearStoredCredentials() {
                    localStorage.removeItem('chfsAuthHeader');
                    localStorage.removeItem('chfsAuthUser');
                },

                resetCredentials() {
                    this.authHeader = '';
                    this.clearStoredCredentials();
                },

                setSection(section) {
                    this.currentSection = section;
                },

                buildRepositoryCatalog(roots) {
                    const palette = [
                        { label: 'Core', class: 'bg-blue-100 text-blue-700' },
                        { label: 'Team', class: 'bg-purple-100 text-purple-700' },
                        { label: 'Docs', class: 'bg-emerald-100 text-emerald-700' },
                        { label: 'Ops', class: 'bg-amber-100 text-amber-700' },
                        { label: 'Lab', class: 'bg-rose-100 text-rose-700' },
                    ];

                    const existing = new Map(this.repositories.map(repo => [repo.name, repo]));
                    const availableRoots = Array.isArray(roots) ? roots : this.accessibleRoots;

                    const mapped = availableRoots.map((root, index) => {
                        const previous = existing.get(root) || {};
                        const paletteItem = palette[index % palette.length];
                        return {
                            name: root,
                            description: previous.description || `Shared repository ${root}`,
                            branch: previous.branch || 'main',
                            watchers: previous.watchers ?? (index + 1) * 2,
                            stars: previous.stars ?? (index + 1) * 4,
                            forks: previous.forks ?? Math.max(1, index),
                            stats: previous.stats || { files: 0, directories: 0, size: 0, lastUpdated: null },
                            badgeLabel: previous.badgeLabel || paletteItem.label,
                            badgeClass: previous.badgeClass || paletteItem.class,
                        };
                    });

                    this.repositories = mapped;

                    for (const root of availableRoots) {
                        if (!existing.has(root)) {
                            this.recordActivity('Repository', `Discovered repository ${root}`, root);
                        }
                    }

                    this.activityFeed = this.activityFeed.filter(entry => !entry.repository || availableRoots.includes(entry.repository));

                    if (this.currentRoot && !availableRoots.includes(this.currentRoot)) {
                        this.currentRoot = '';
                        this.currentPath = '';
                    }

                    if (this.repositories.length === 0) {
                        this.currentSection = 'dashboard';
                    }
                },

                selectRepository(name) {
                    if (!name) {
                        return;
                    }
                    const previousRoot = this.currentRoot;
                    this.currentRoot = name;
                    this.currentPath = '';
                    this.selectedFiles = [];
                    this.currentSection = 'repository';

                    if (previousRoot !== name) {
                        this.recordActivity('View', `Opened ${name}`, name);
                    }

                    if (this.isAuthenticated || this.authHeader) {
                        this.loadFiles();
                    }
                },

                navigateToRepoRoot() {
                    if (!this.currentRoot) {
                        return;
                    }
                    this.currentPath = '';
                    this.selectedFiles = [];
                    this.loadFiles();
                },

                calculateRepoStats(files) {
                    const stats = { files: 0, directories: 0, size: 0, lastUpdated: null };
                    if (!Array.isArray(files)) {
                        return stats;
                    }

                    for (const entry of files) {
                        if (entry.is_dir) {
                            stats.directories += 1;
                        } else {
                            stats.files += 1;
                            stats.size += entry.size || 0;
                        }

                        if (!stats.lastUpdated || (entry.modified || 0) > stats.lastUpdated) {
                            stats.lastUpdated = entry.modified || stats.lastUpdated;
                        }
                    }

                    return stats;
                },

                updateRepositoryStats(name, stats) {
                    const repo = this.repositories.find(item => item.name === name);
                    if (repo) {
                        repo.stats = { ...repo.stats, ...stats };
                    }
                },

                setFileSort(option) {
                    this.fileSortOption = option;
                },

                recordActivity(type, message, repository = this.currentRoot) {
                    const entry = {
                        id: `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                        type,
                        message,
                        repository,
                        timestamp: Date.now(),
                    };
                    this.activityFeed.unshift(entry);
                    if (this.activityFeed.length > 30) {
                        this.activityFeed = this.activityFeed.slice(0, 30);
                    }
                },

                focusLogin() {
                    this.$nextTick(() => {
                        if (this.$refs.loginUsername) {
                            this.$refs.loginUsername.focus();
                        }
                    });
                },

                switchToRegister() {
                    this.showRegister = true;
                    this.registerUsername = this.loginUsername || '';
                    this.registerPassword = '';
                    this.registerConfirm = '';
                    this.registerError = '';
                    this.loginError = '';
                    this.loginInfo = '';
                    this.$nextTick(() => {
                        if (this.$refs.registerUsername) {
                            this.$refs.registerUsername.focus();
                        }
                    });
                },

                switchToLogin(message = '') {
                    this.showRegister = false;
                    this.registerUsername = '';
                    this.registerPassword = '';
                    this.registerConfirm = '';
                    this.registerError = '';
                    if (message) {
                        this.loginInfo = message;
                        this.loginError = '';
                    } else {
                        this.loginInfo = '';
                    }
                    this.$nextTick(() => this.focusLogin());
                },

                async performRegister() {
                    const username = (this.registerUsername || '').trim();
                    this.registerError = '';
                    this.loginInfo = '';
                    if (!username || username.length < 3) {
                        this.registerError = 'Username must be at least 3 characters.';
                        return;
                    }

                    if (!this.registerPassword || this.registerPassword.length < 6) {
                        this.registerError = 'Password must be at least 6 characters.';
                        return;
                    }

                    if (this.registerPassword !== this.registerConfirm) {
                        this.registerError = 'Passwords do not match.';
                        return;
                    }

                    try {
                        const response = await fetch('/api/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                username,
                                password: this.registerPassword,
                                confirmPassword: this.registerConfirm,
                            }),
                        });

                        const payload = this.parseApiResponse(await response.json());
                        if (response.ok && payload.code === 0) {
                            this.registerError = '';
                            this.loginUsername = username;
                            this.loginPassword = '';
                            this.switchToLogin('Registration successful! Please sign in.');
                        } else {
                            this.registerError = payload?.msg || 'Registration failed.';
                        }
                    } catch (e) {
                        this.registerError = 'Registration failed: ' + e.message;
                    }
                },

                async tryAutoLogin() {
                    const savedHeader = localStorage.getItem('chfsAuthHeader');
                    const savedUser = localStorage.getItem('chfsAuthUser');

                    if (savedUser && !this.loginUsername) {
                        this.loginUsername = savedUser;
                    }

                    if (savedHeader) {
                        this.authHeader = savedHeader;
                        this.rememberCredentials = true;
                        const success = await this.refreshSession(false);
                        if (success) {
                            if (this.currentRoot) {
                                await this.loadFiles();
                            }
                            return true;
                        }
                        this.resetCredentials();
                    }

                    if (!this.isAuthenticated) {
                        this.focusLogin();
                    }

                    return false;
                },

                ensureAuthenticated(showMessage = true) {
                    if (this.isAuthenticated || this.authHeader) {
                        return true;
                    }
                    if (showMessage) {
                        this.loginError = 'Please log in to continue.';
                        this.loginInfo = '';
                        this.focusLogin();
                    }
                    return false;
                },

                async loadControlPanel(force = false) {
                    if (!this.ensureAuthenticated(false)) {
                        return;
                    }
                    if (this.controlPanelLoading) {
                        return;
                    }
                    if (!force && this.controlPanelData) {
                        return;
                    }

                    this.controlPanelLoading = true;
                    this.controlPanelError = '';

                    try {
                        const response = await fetch('/api/admin/status', {
                            headers: this.buildHeaders()
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.controlPanelData = payload.data || {};
                            this.controlPanelFetchedAt = new Date().toISOString();
                            const urls = Array.isArray(this.controlPanelData?.server?.custom_urls)
                                ? this.controlPanelData.server.custom_urls
                                : [];
                            this.customUrlEditor = urls.join('\n');
                            this.customUrlSaving = false;
                        } else {
                            this.controlPanelError = payload.msg || 'Failed to load control panel data.';
                        }
                    } catch (e) {
                        this.controlPanelError = 'Failed to load control panel data: ' + e.message;
                    } finally {
                        this.controlPanelLoading = false;
                    }
                },

                async openControlPanel() {
                    if (!this.ensureAuthenticated()) {
                        return;
                    }
                    this.showControlPanel = true;
                    await this.loadControlPanel(true);
                },

                async refreshControlPanel() {
                    await this.loadControlPanel(true);
                },

                async updateShareQuota(name, payload) {
                    if (!this.ensureAuthenticated(false)) {
                        return;
                    }
                    this.controlPanelError = '';
                    this.controlPanelNotice = '';

                    try {
                        const response = await fetch(`/api/admin/shares/${encodeURIComponent(name)}/quota`, {
                            method: 'PUT',
                            headers: this.buildHeaders({ 'Content-Type': 'application/json' }),
                            body: JSON.stringify(payload || {})
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payloadData = this.parseApiResponse(await response.json());
                        if (response.ok && payloadData.code === 0) {
                            this.controlPanelNotice = `Quota updated for ${name}.`;
                            await this.refreshControlPanel();
                        } else {
                            this.controlPanelError = payloadData?.msg || 'Failed to update share quota.';
                        }
                    } catch (e) {
                        this.controlPanelError = 'Failed to update share quota: ' + e.message;
                    }
                },

                async promptShareQuota(share) {
                    if (!share || !share.name) {
                        return;
                    }
                    const current = share.quota?.limit_display || '';
                    const value = window.prompt('Enter a quota (e.g. 10GB). Leave blank to remove the limit.', current);
                    if (value === null) {
                        return;
                    }
                    const trimmed = value.trim();
                    if (!trimmed) {
                        await this.clearShareQuota(share);
                        return;
                    }
                    await this.updateShareQuota(share.name, { quota: trimmed });
                },

                async clearShareQuota(share) {
                    if (!share || !share.name) {
                        return;
                    }
                    if (!window.confirm(`Remove the quota limit for "${share.name}"?`)) {
                        return;
                    }
                    await this.updateShareQuota(share.name, {});
                },

                async updateServerUrls() {
                    if (!this.ensureAuthenticated(false)) {
                        return;
                    }

                    const entries = (this.customUrlEditor || '').split('\n')
                        .map(line => line.trim())
                        .filter(Boolean);

                    this.customUrlSaving = true;
                    this.controlPanelError = '';
                    this.controlPanelNotice = '';

                    try {
                        const response = await fetch('/api/admin/server/custom-urls', {
                            method: 'PUT',
                            headers: this.buildHeaders({ 'Content-Type': 'application/json' }),
                            body: JSON.stringify({ urls: entries })
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (response.ok && payload.code === 0) {
                            this.controlPanelNotice = 'Server URLs updated.';
                            await this.refreshControlPanel();
                        } else {
                            this.controlPanelError = payload?.msg || 'Failed to update server URLs.';
                        }
                    } catch (e) {
                        this.controlPanelError = 'Failed to update server URLs: ' + e.message;
                    } finally {
                        this.customUrlSaving = false;
                    }
                },

                async removeUser(username) {
                    if (!username) {
                        return;
                    }
                    if (!window.confirm(`Remove user "${username}"?`)) {
                        return;
                    }

                    this.controlPanelError = '';
                    this.controlPanelNotice = '';

                    try {
                        const response = await fetch(`/api/admin/users/${encodeURIComponent(username)}`, {
                            method: 'DELETE',
                            headers: this.buildHeaders()
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (response.ok && payload.code === 0) {
                            this.controlPanelNotice = `Removed user ${username}.`;
                            await this.refreshControlPanel();
                        } else {
                            this.controlPanelError = payload?.msg || 'Failed to remove user.';
                        }
                    } catch (e) {
                        this.controlPanelError = 'Failed to remove user: ' + e.message;
                    }
                },

                closeControlPanel() {
                    this.showControlPanel = false;
                    this.controlPanelNotice = '';
                },

                parseApiResponse(data) {
                    if (data && typeof data === 'object' && 'detail' in data) {
                        return data.detail;
                    }
                    return data;
                },

                async refreshSession(showErrors = true) {
                    if (!this.authHeader) {
                        return false;
                    }

                    try {
                        const response = await fetch('/api/session', {
                            headers: this.buildHeaders()
                        });

                    if (response.status === 401) {
                        if (showErrors) {
                            this.loginError = 'Invalid username or password.';
                            this.loginInfo = '';
                        }
                        this.handleUnauthorized(null);
                        return false;
                    }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.isAuthenticated = true;
                            this.loginError = '';
                            this.loginInfo = '';
                            this.currentUser = payload.data?.user?.name || this.loginUsername;
                            if (!this.loginUsername) {
                                this.loginUsername = this.currentUser;
                            }

                            const roots = Array.isArray(payload.data?.roots) ? payload.data.roots : [];
                            this.accessibleRoots = roots;
                            this.buildRepositoryCatalog(roots);

                            if (this.currentRoot && !roots.includes(this.currentRoot)) {
                                this.currentRoot = '';
                                this.currentPath = '';
                            }

                            if (!this.currentRoot && roots.length > 0 && this.currentSection === 'repository') {
                                this.currentRoot = roots[0];
                            }

                            if (!this.currentRoot) {
                                this.currentSection = 'repositories';
                            }

                            await this.refreshDirectTransferLists();
                            return true;
                        }

                        if (showErrors) {
                            this.loginError = payload.msg || 'Failed to verify credentials.';
                            this.loginInfo = '';
                        }
                        return false;
                    } catch (e) {
                        if (showErrors) {
                            this.loginError = 'Login failed: ' + e.message;
                            this.loginInfo = '';
                        }
                        return false;
                    }
                },

                async performLogin() {
                    const username = (this.loginUsername || '').trim();
                    if (!username || !this.loginPassword) {
                        this.loginError = 'Please enter username and password.';
                        this.loginInfo = '';
                        this.focusLogin();
                        return false;
                    }

                    try {
                        this.loginUsername = username;
                        this.authHeader = this.createAuthHeader(username, this.loginPassword);
                    } catch (e) {
                        this.loginError = 'Failed to encode credentials.';
                        this.loginInfo = '';
                        return false;
                    }

                    const success = await this.refreshSession(true);
                    if (success) {
                        this.error = null;
                        this.loginPassword = '';
                        this.loginError = '';
                        this.loginInfo = '';

                        if (this.rememberCredentials) {
                            localStorage.setItem('chfsAuthHeader', this.authHeader);
                            localStorage.setItem('chfsAuthUser', this.currentUser);
                        } else {
                            this.clearStoredCredentials();
                        }

                        if (this.currentRoot) {
                            await this.loadFiles();
                        } else {
                            this.files = [];
                            this.selectedFiles = [];
                            this.currentSection = this.repositories.length > 0 ? 'repositories' : 'dashboard';
                        }
                    } else {
                        this.resetCredentials();
                    }
                    return success;
                },

                handleUnauthorized(message = 'Session expired. Please log in again.') {
                    this.isAuthenticated = false;
                    this.accessibleRoots = [];
                    this.files = [];
                    this.currentRoot = '';
                    this.currentPath = '';
                    this.repositories = [];
                    this.currentSection = 'repositories';
                    this.activityFeed = [];
                    this.activeRepoStats = { files: 0, directories: 0, size: 0, lastUpdated: null };
                    this.repositorySearch = '';
                    this.repositorySort = 'name';
                    this.fileSortOption = 'name';
                    this.selectedFiles = [];
                    this.error = null;
                    this.showUpload = false;
                    this.showNewFolder = false;
                    this.showDirectTransfer = false;
                    this.showRename = false;
                    this.showControlPanel = false;
                    this.uploadFiles = [];
                    this.uploading = false;
                    this.renameTarget = null;
                    this.renameValue = '';
                    this.directTransferRecipients = [];
                    this.directTransferRecipientsLoading = false;
                    this.directTransferRecipient = '';
                    this.directTransferFile = null;
                    this.directTransferSending = false;
                    this.directTransferSuccess = '';
                    this.directTransferError = '';
                    this.directTransferListError = '';
                    this.directTransferIncoming = [];
                    this.directTransferOutgoing = [];
                    this.directTransferListLoading = false;
                    this.directTransferTab = 'incoming';
                    this.controlPanelData = null;
                    this.controlPanelError = '';
                    this.controlPanelFetchedAt = null;
                    this.controlPanelLoading = false;
                    this.customUrlEditor = '';
                    this.customUrlSaving = false;

                    if (message !== null) {
                        this.error = message;
                        this.loginError = message;
                        this.loginInfo = '';
                    }

                    this.resetCredentials();
                    this.focusLogin();
                },

                logout() {
                    this.isAuthenticated = false;
                    this.accessibleRoots = [];
                    this.files = [];
                    this.currentRoot = '';
                    this.currentPath = '';
                    this.repositories = [];
                    this.currentSection = 'repositories';
                    this.activityFeed = [];
                    this.activeRepoStats = { files: 0, directories: 0, size: 0, lastUpdated: null };
                    this.repositorySearch = '';
                    this.repositorySort = 'name';
                    this.fileSortOption = 'name';
                    this.selectedFiles = [];
                    this.error = null;
                    this.loginError = '';
                    this.loginPassword = '';
                    this.showUpload = false;
                    this.showNewFolder = false;
                    this.showDirectTransfer = false;
                    this.showRename = false;
                    this.showControlPanel = false;
                    this.uploadFiles = [];
                    this.uploading = false;
                    this.renameTarget = null;
                    this.renameValue = '';
                    this.directTransferRecipients = [];
                    this.directTransferRecipientsLoading = false;
                    this.directTransferRecipient = '';
                    this.directTransferFile = null;
                    this.directTransferSending = false;
                    this.directTransferSuccess = '';
                    this.directTransferError = '';
                    this.directTransferListError = '';
                    this.directTransferIncoming = [];
                    this.directTransferOutgoing = [];
                    this.directTransferListLoading = false;
                    this.directTransferTab = 'incoming';
                    this.controlPanelData = null;
                    this.controlPanelError = '';
                    this.controlPanelFetchedAt = null;
                    this.controlPanelLoading = false;
                    this.customUrlEditor = '';
                    this.customUrlSaving = false;
                    this.resetCredentials();
                    this.focusLogin();
                },

                async loadFiles() {
                    if (!this.currentRoot) {
                        this.files = [];
                        this.selectedFiles = [];
                        this.activeRepoStats = { files: 0, directories: 0, size: 0, lastUpdated: null };
                        return;
                    }

                    if (!this.ensureAuthenticated(false)) {
                        return;
                    }

                    this.loading = true;
                    this.error = null;

                    try {
                        const response = await fetch(`/api/list?root=${encodeURIComponent(this.currentRoot)}&path=${encodeURIComponent(this.currentPath)}`, {
                            headers: this.buildHeaders()
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.files = payload.data?.files || [];
                            this.selectedFiles = [];
                            const stats = this.calculateRepoStats(this.files);
                            this.activeRepoStats = stats;
                            this.updateRepositoryStats(this.currentRoot, stats);
                        } else {
                            this.error = payload.msg || 'Failed to load files.';
                        }
                    } catch (e) {
                        this.error = 'Failed to load files: ' + e.message;
                    } finally {
                        this.loading = false;
                    }
                },

                navigateToFolder(path) {
                    this.currentPath = path;
                    this.selectedFiles = [];
                    this.loadFiles();
                },

                navigateUp() {
                    const parts = this.pathParts;
                    parts.pop();
                    this.currentPath = parts.join('/');
                    this.selectedFiles = [];
                    this.loadFiles();
                },

                navigateToPath(index) {
                    const parts = this.pathParts.slice(0, index + 1);
                    this.currentPath = parts.join('/');
                    this.selectedFiles = [];
                    this.loadFiles();
                },

                async downloadFile(file) {
                    if (!file || !file.path) return;
                    if (!this.ensureAuthenticated(false)) return;

                    try {
                        const response = await fetch(`/api/download?root=${encodeURIComponent(this.currentRoot)}&path=${encodeURIComponent(file.path)}`, {
                            headers: this.buildHeaders()
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        if (!response.ok) {
                            throw new Error('Download failed with status ' + response.status);
                        }

                        const blob = await response.blob();
                        let filename = file.name || file.path.split('/').pop() || 'download';
                        const disposition = response.headers.get('content-disposition');
                        if (disposition) {
                            const utfMatch = disposition.match(/filename\*=UTF-8''([^;]+)/i);
                            const asciiMatch = disposition.match(/filename="?([^";]+)"?/i);
                            if (utfMatch) {
                                filename = decodeURIComponent(utfMatch[1]);
                            } else if (asciiMatch) {
                                filename = asciiMatch[1];
                            }
                        }

                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    } catch (e) {
                        alert('Download failed: ' + e.message);
                    }
                },

                async deleteFile(target) {
                    if (!this.ensureAuthenticated()) return;
                    const fileObj = target && typeof target === 'object' ? target : null;
                    const path = fileObj ? fileObj.path : target;
                    if (!path) return;

                    const displayName = fileObj?.name || (typeof target === 'string' ? target.split('/')?.pop() || target : 'item');
                    if (!confirm(`Are you sure you want to delete ${displayName}?`)) return;

                    try {
                        const response = await fetch('/api/delete', {
                            method: 'POST',
                            headers: this.buildHeaders({'Content-Type': 'application/json'}),
                            body: JSON.stringify({
                                root: this.currentRoot,
                                paths: [path]
                            })
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            this.recordActivity('Delete', `Deleted ${displayName}`, this.currentRoot);
                            this.loadFiles();
                        } else {
                            alert('Delete failed: ' + (payload.msg || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Delete failed: ' + e.message);
                    }
                },

                async deleteSelected() {
                    if (!this.ensureAuthenticated()) return;
                    if (this.selectedFiles.length === 0) return;
                    if (!confirm(`Delete ${this.selectedFiles.length} selected items?`)) return;

                    try {
                        const response = await fetch('/api/delete', {
                            method: 'POST',
                            headers: this.buildHeaders({'Content-Type': 'application/json'}),
                            body: JSON.stringify({
                                root: this.currentRoot,
                                paths: this.selectedFiles
                            })
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            const removedCount = this.selectedFiles.length;
                            this.selectedFiles = [];
                            this.recordActivity('Delete', `Deleted ${removedCount} item${removedCount !== 1 ? 's' : ''}`, this.currentRoot);
                            this.loadFiles();
                        } else {
                            alert('Delete failed: ' + (payload.msg || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Delete failed: ' + e.message);
                    }
                },

                renameFile(file) {
                    this.renameTarget = file;
                    this.renameValue = file?.name || '';
                    this.showRename = true;
                },

                async confirmRename() {
                    if (!this.ensureAuthenticated()) return;
                    if (!this.renameTarget || !this.renameValue.trim()) return;

                    try {
                        const response = await fetch('/api/rename', {
                            method: 'POST',
                            headers: this.buildHeaders({'Content-Type': 'application/json'}),
                            body: JSON.stringify({
                                root: this.currentRoot,
                                path: this.renameTarget.path,
                                newName: this.renameValue.trim()
                            })
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            const originalName = this.renameTarget?.name || this.renameTarget?.path?.split('/')?.pop() || 'item';
                            const newName = this.renameValue.trim();
                            this.recordActivity('Rename', `Renamed ${originalName} to ${newName}`, this.currentRoot);
                            this.showRename = false;
                            this.renameTarget = null;
                            this.renameValue = '';
                            this.loadFiles();
                        } else {
                            alert('Rename failed: ' + (payload.msg || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Rename failed: ' + e.message);
                    }
                },

                async createFolder() {
                    if (!this.ensureAuthenticated()) return;
                    const folderName = (this.newFolderName || '').trim();
                    if (!folderName) return;

                    try {
                        const response = await fetch('/api/mkdir', {
                            method: 'POST',
                            headers: this.buildHeaders({'Content-Type': 'application/json'}),
                            body: JSON.stringify({
                                root: this.currentRoot,
                                path: this.currentPath ? `${this.currentPath}/${folderName}` : folderName
                            })
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (payload.code === 0) {
                            const createdPath = this.currentPath ? `${this.currentPath}/${folderName}` : folderName;
                            this.recordActivity('Folder', `Created ${createdPath}`, this.currentRoot);
                            this.showNewFolder = false;
                            this.newFolderName = '';
                            this.loadFiles();
                        } else {
                            alert('Create folder failed: ' + (payload.msg || 'Unknown error'));
                        }
                    } catch (e) {
                        alert('Create folder failed: ' + e.message);
                    }
                },

                handleFileSelect(event) {
                    this.uploadFiles = Array.from(event.target.files);
                },

                handleUploadDrop(event) {
                    event.target.classList.remove('border-blue-500', 'bg-blue-50');
                    this.uploadFiles = Array.from(event.dataTransfer.files);
                },

                handleDrop(event) {
                    event.target.classList.remove('drag-over');
                    this.uploadFiles = Array.from(event.dataTransfer.files);
                    this.showUpload = true;
                },

                async uploadSelectedFiles() {
                    if (!this.ensureAuthenticated()) return;
                    if (this.uploadFiles.length === 0) return;

                    this.uploading = true;

                    try {
                        for (const file of this.uploadFiles) {
                            const formData = new FormData();
                            formData.append('root', this.currentRoot);
                            formData.append('path', this.currentPath);
                            formData.append('file', file);

                            const response = await fetch('/api/upload', {
                                method: 'POST',
                                headers: this.buildHeaders(),
                                body: formData
                            });

                            if (response.status === 401) {
                                this.handleUnauthorized();
                                return;
                            }

                            const payload = this.parseApiResponse(await response.json());
                            if (payload.code !== 0) {
                                alert(`Upload failed for ${file.name}: ${payload.msg || 'Unknown error'}`);
                            } else {
                                this.recordActivity('Upload', `Uploaded ${file.name}`, this.currentRoot);
                            }
                        }

                        this.showUpload = false;
                        this.uploadFiles = [];
                        this.loadFiles();

                    } catch (e) {
                        alert('Upload failed: ' + e.message);
                    } finally {
                        this.uploading = false;
                    }
                },

                async openDirectTransfer() {
                    if (!this.ensureAuthenticated()) {
                        return;
                    }
                    this.directTransferError = '';
                    this.directTransferSuccess = '';
                    this.directTransferListError = '';
                    this.directTransferFile = null;
                    this.directTransferTab = 'incoming';
                    this.showDirectTransfer = true;
                    if (this.$refs.directTransferFileInput) {
                        this.$refs.directTransferFileInput.value = '';
                    }
                    await Promise.all([
                        this.loadDirectTransferRecipients(),
                        this.refreshDirectTransferLists(),
                    ]);
                },

                closeDirectTransfer() {
                    this.showDirectTransfer = false;
                    this.directTransferSending = false;
                    this.directTransferRecipientsLoading = false;
                    this.directTransferFile = null;
                    this.directTransferError = '';
                    this.directTransferSuccess = '';
                    this.directTransferListError = '';
                    if (this.$refs.directTransferFileInput) {
                        this.$refs.directTransferFileInput.value = '';
                    }
                },

                handleDirectTransferFile(event) {
                    const files = event?.target?.files;
                    this.directTransferFile = files && files[0] ? files[0] : null;
                },

                async loadDirectTransferRecipients() {
                    if (!this.ensureAuthenticated(false)) {
                        return;
                    }
                    this.directTransferRecipientsLoading = true;
                    try {
                        const response = await fetch('/api/direct-transfer/recipients', {
                            headers: this.buildHeaders(),
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (response.ok && payload.code === 0) {
                            const names = Array.isArray(payload.data?.recipients) ? payload.data.recipients : [];
                            this.directTransferRecipients = names;
                            if (!names.includes(this.directTransferRecipient)) {
                                this.directTransferRecipient = names[0] || '';
                            }
                        } else {
                            this.directTransferListError = payload?.msg || 'Failed to load recipients.';
                        }
                    } catch (e) {
                        this.directTransferListError = 'Failed to load recipients: ' + e.message;
                    } finally {
                        this.directTransferRecipientsLoading = false;
                    }
                },

                async fetchDirectTransferList(direction) {
                    try {
                        const response = await fetch(`/api/direct-transfer/list?direction=${encodeURIComponent(direction)}`, {
                            headers: this.buildHeaders(),
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return [];
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (response.ok && payload.code === 0) {
                            const transfers = Array.isArray(payload.data?.transfers) ? payload.data.transfers : [];
                            return transfers;
                        }

                        throw new Error(payload?.msg || 'Failed to load transfers.');
                    } catch (e) {
                        throw new Error(e.message || 'Failed to load transfers.');
                    }
                },

                async refreshDirectTransferLists() {
                    if (!this.ensureAuthenticated(false)) {
                        this.directTransferIncoming = [];
                        this.directTransferOutgoing = [];
                        return;
                    }
                    this.directTransferListLoading = true;
                    this.directTransferListError = '';
                    try {
                        const [incoming, outgoing] = await Promise.all([
                            this.fetchDirectTransferList('incoming'),
                            this.fetchDirectTransferList('outgoing'),
                        ]);
                        this.directTransferIncoming = incoming;
                        this.directTransferOutgoing = outgoing;
                    } catch (e) {
                        this.directTransferListError = e.message || 'Failed to load transfers.';
                    } finally {
                        this.directTransferListLoading = false;
                    }
                },

                async sendDirectTransfer() {
                    if (!this.ensureAuthenticated()) {
                        return;
                    }
                    if (!this.directTransferRecipient) {
                        this.directTransferError = 'Please choose a recipient.';
                        return;
                    }
                    if (!this.directTransferFile) {
                        this.directTransferError = 'Please select a file to send.';
                        return;
                    }

                    this.directTransferError = '';
                    this.directTransferSuccess = '';
                    this.directTransferSending = true;

                    const formData = new FormData();
                    formData.append('recipient', this.directTransferRecipient);
                    formData.append('file', this.directTransferFile);

                    try {
                        const response = await fetch('/api/direct-transfer/send', {
                            method: 'POST',
                            headers: this.buildHeaders(),
                            body: formData,
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (response.ok && payload.code === 0) {
                            const filename = payload.data?.transfer?.filename || (this.directTransferFile?.name || 'file');
                            this.directTransferSuccess = `Sent ${filename} to ${this.directTransferRecipient}.`;
                            this.directTransferFile = null;
                            if (this.$refs.directTransferFileInput) {
                                this.$refs.directTransferFileInput.value = '';
                            }
                            await this.refreshDirectTransferLists();
                        } else {
                            this.directTransferError = payload?.msg || 'Failed to send transfer.';
                        }
                    } catch (e) {
                        this.directTransferError = 'Failed to send transfer: ' + e.message;
                    } finally {
                        this.directTransferSending = false;
                    }
                },

                async downloadDirectTransfer(item) {
                    if (!item || !item.id) {
                        return;
                    }
                    if (!this.ensureAuthenticated()) {
                        return;
                    }

                    this.directTransferError = '';

                    try {
                        const response = await fetch(`/api/direct-transfer/download/${encodeURIComponent(item.id)}`, {
                            headers: this.buildHeaders(),
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        if (!response.ok) {
                            const payload = this.parseApiResponse(await response.json());
                            this.directTransferError = payload?.msg || 'Failed to download transfer.';
                            return;
                        }

                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = item.filename || 'download';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        this.directTransferSuccess = `Downloaded ${item.filename || 'file'}.`;
                        await this.refreshDirectTransferLists();
                    } catch (e) {
                        this.directTransferError = 'Failed to download transfer: ' + e.message;
                    }
                },

                async deleteDirectTransfer(item, direction = 'incoming') {
                    if (!item || !item.id) {
                        return;
                    }
                    if (!this.ensureAuthenticated()) {
                        return;
                    }

                    this.directTransferError = '';

                    try {
                        const response = await fetch(`/api/direct-transfer/${encodeURIComponent(item.id)}`, {
                            method: 'DELETE',
                            headers: this.buildHeaders(),
                        });

                        if (response.status === 401) {
                            this.handleUnauthorized();
                            return;
                        }

                        const payload = this.parseApiResponse(await response.json());
                        if (response.ok && payload.code === 0) {
                            const action = direction === 'outgoing' ? 'Transfer cancelled.' : 'Transfer removed.';
                            this.directTransferSuccess = payload?.msg || action;
                            await this.refreshDirectTransferLists();
                        } else {
                            this.directTransferError = payload?.msg || 'Failed to remove transfer.';
                        }
                    } catch (e) {
                        this.directTransferError = 'Failed to remove transfer: ' + e.message;
                    }
                },

                selectAll() {
                    this.selectedFiles = this.files.map(f => f.path);
                },

                toggleSelectAll() {
                    if (this.selectedFiles.length === this.files.length) {
                        this.selectedFiles = [];
                    } else {
                        this.selectAll();
                    }
                },

                formatFileSize(bytes) {
                    if (!bytes) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                },

                formatDate(timestamp) {
                    if (!timestamp) return '';
                    const date = new Date(timestamp * 1000);
                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                },

                formatRelativeTime(value) {
                    if (!value) {
                        return 'just now';
                    }

                    const timestamp = typeof value === 'number' && value < 1e12 ? value * 1000 : value;
                    const diff = Date.now() - timestamp;

                    const units = [
                        { label: 'year', ms: 1000 * 60 * 60 * 24 * 365 },
                        { label: 'month', ms: 1000 * 60 * 60 * 24 * 30 },
                        { label: 'week', ms: 1000 * 60 * 60 * 24 * 7 },
                        { label: 'day', ms: 1000 * 60 * 60 * 24 },
                        { label: 'hour', ms: 1000 * 60 * 60 },
                        { label: 'minute', ms: 1000 * 60 },
                    ];

                    for (const unit of units) {
                        if (diff >= unit.ms) {
                            const value = Math.floor(diff / unit.ms);
                            return `${value} ${unit.label}${value !== 1 ? 's' : ''} ago`;
                        }
                    }

                    const seconds = Math.max(1, Math.floor(diff / 1000));
                    return `${seconds} second${seconds !== 1 ? 's' : ''} ago`;
                }
            };
        }
    </script>
</body>
</html>
